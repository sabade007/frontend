import { CHAR_HYPHEN, CHAR_NO_BREAK_SPACE, getDocumentOrShadowRoot, isNativeFocused, isSafari, tuiAssert, } from '@taiga-ui/cdk';
/**
 * Used to finish a number with zeros to a given precision
 */
export function tuiCreateAutoCorrectedNumberPipe(decimalLimit, decimalSymbol, thousandSymbol, nativeInput, allowNegative, isIOS) {
    if (decimalLimit === void 0) { decimalLimit = 0; }
    if (decimalSymbol === void 0) { decimalSymbol = ","; }
    if (thousandSymbol === void 0) { thousandSymbol = CHAR_NO_BREAK_SPACE; }
    if (isIOS === void 0) { isIOS = false; }
    tuiAssert.assert(Number.isInteger(decimalLimit));
    tuiAssert.assert(decimalLimit >= 0);
    // Guess for which browser I need this :)
    var previousCaret = -1;
    var unlucky = (!!nativeInput && isSafari(nativeInput)) || isIOS;
    if (nativeInput && unlucky) {
        nativeInput.addEventListener("beforeinput", function () {
            previousCaret = nativeInput.selectionStart || 0;
        });
    }
    return function (conformedValue, config) {
        // Removing everything by selecting and pressing '-'
        if (!conformedValue && config.rawValue === CHAR_HYPHEN && allowNegative) {
            return CHAR_HYPHEN;
        }
        // remove these hacks after text mask library has changed
        if (nativeInput && unlucky && isNativeFocused(nativeInput)) {
            var caret_1 = calculateSafariCaret(config.previousConformedValue, conformedValue, previousCaret);
            setTimeout(function () {
                nativeInput.setSelectionRange(caret_1, caret_1);
            });
        }
        if (nativeInput &&
            nativeInput.ownerDocument !== getDocumentOrShadowRoot(nativeInput) &&
            isNativeFocused(nativeInput) &&
            config.currentCaretPosition) {
            var realCaretPosition_1 = config.currentCaretPosition +
                calculateCaretGap(config.previousConformedValue, conformedValue, thousandSymbol);
            setTimeout(function () {
                nativeInput.setSelectionRange(realCaretPosition_1, realCaretPosition_1);
            });
        }
        if (conformedValue === "" || !decimalLimit) {
            return { value: conformedValue };
        }
        var withDecimalSymbol = addDecimalSymbolIfNeeded(conformedValue, decimalSymbol);
        var decimalPart = withDecimalSymbol.split(decimalSymbol)[1];
        var zeroPaddingSize = decimalLimit - decimalPart.length;
        return {
            value: withDecimalSymbol + "0".repeat(zeroPaddingSize),
        };
    };
}
function addDecimalSymbolIfNeeded(value, decimalSymbol) {
    if (decimalSymbol === void 0) { decimalSymbol = ","; }
    return !value.includes(decimalSymbol) ? value + decimalSymbol : value;
}
function calculateSafariCaret(previousValue, current, previousCaret, decimalSymbol) {
    if (previousValue === void 0) { previousValue = ""; }
    if (decimalSymbol === void 0) { decimalSymbol = ","; }
    var tailRegex = new RegExp(decimalSymbol + ".+");
    var previousWithoutTail = previousValue.replace(tailRegex, "");
    var currentWithoutTail = current.replace(tailRegex, "");
    var pasteOrCutOperation = Math.abs(previousWithoutTail.length - currentWithoutTail.length) > 2;
    if (pasteOrCutOperation) {
        return current.length;
    }
    if (previousValue.length === current.length) {
        if (previousValue.indexOf(decimalSymbol) <= previousCaret) {
            return calculateChangedTailIndex(previousValue, current);
        }
        return previousWithoutTail === currentWithoutTail
            ? previousCaret - 1
            : previousCaret + 1;
    }
    if (previousValue.length === 0) {
        return 1;
    }
    var changeLength = current.length - previousValue.length;
    return previousCaret + changeLength;
}
function calculateChangedTailIndex(previous, current) {
    for (var i = 0; i < current.length; i++) {
        if (previous[i] !== current[i]) {
            return current[i] === "0" ? i : i + 1;
        }
    }
    return current.length;
}
function calculateCaretGap(previousValue, current, thousandSymbol) {
    if (previousValue === void 0) { previousValue = ""; }
    var pasteOrCutOperation = Math.abs(previousValue.length - current.length) > 2;
    if (pasteOrCutOperation) {
        return 0;
    }
    var wereSpaces = previousValue.split(thousandSymbol).length;
    var nowSpaces = current.split(thousandSymbol).length;
    return nowSpaces - wereSpaces;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkvY29yZS91dGlscy9tYXNrLyIsInNvdXJjZXMiOlsiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFdBQVcsRUFDWCxtQkFBbUIsRUFDbkIsdUJBQXVCLEVBQ3ZCLGVBQWUsRUFDZixRQUFRLEVBQ1IsU0FBUyxHQUNaLE1BQU0sZUFBZSxDQUFDO0FBSXZCOztHQUVHO0FBQ0gsTUFBTSxVQUFVLGdDQUFnQyxDQUM1QyxZQUF3QixFQUN4QixhQUFxQyxFQUNyQyxjQUE0QyxFQUM1QyxXQUFxQyxFQUNyQyxhQUF1QixFQUN2QixLQUFhO0lBTGIsNkJBQUEsRUFBQSxnQkFBd0I7SUFDeEIsOEJBQUEsRUFBQSxtQkFBcUM7SUFDckMsK0JBQUEsRUFBQSxvQ0FBNEM7SUFHNUMsc0JBQUEsRUFBQSxhQUFhO0lBRWIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFDakQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFcEMseUNBQXlDO0lBQ3pDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLElBQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUM7SUFFbEUsSUFBSSxXQUFXLElBQUksT0FBTyxFQUFFO1FBQ3hCLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUU7WUFDeEMsYUFBYSxHQUFHLFdBQVcsQ0FBQyxjQUFjLElBQUksQ0FBQyxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO0tBQ047SUFFRCxPQUFPLFVBQUMsY0FBYyxFQUFFLE1BQU07UUFDMUIsb0RBQW9EO1FBQ3BELElBQUksQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSyxXQUFXLElBQUksYUFBYSxFQUFFO1lBQ3JFLE9BQU8sV0FBVyxDQUFDO1NBQ3RCO1FBRUQseURBQXlEO1FBQ3pELElBQUksV0FBVyxJQUFJLE9BQU8sSUFBSSxlQUFlLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDeEQsSUFBTSxPQUFLLEdBQUcsb0JBQW9CLENBQzlCLE1BQU0sQ0FBQyxzQkFBc0IsRUFDN0IsY0FBYyxFQUNkLGFBQWEsQ0FDaEIsQ0FBQztZQUVGLFVBQVUsQ0FBQztnQkFDUCxXQUFXLENBQUMsaUJBQWlCLENBQUMsT0FBSyxFQUFFLE9BQUssQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUNJLFdBQVc7WUFDWCxXQUFXLENBQUMsYUFBYSxLQUFLLHVCQUF1QixDQUFDLFdBQVcsQ0FBQztZQUNsRSxlQUFlLENBQUMsV0FBVyxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxvQkFBb0IsRUFDN0I7WUFDRSxJQUFNLG1CQUFpQixHQUNuQixNQUFNLENBQUMsb0JBQW9CO2dCQUMzQixpQkFBaUIsQ0FDYixNQUFNLENBQUMsc0JBQXNCLEVBQzdCLGNBQWMsRUFDZCxjQUFjLENBQ2pCLENBQUM7WUFFTixVQUFVLENBQUM7Z0JBQ1AsV0FBVyxDQUFDLGlCQUFpQixDQUFDLG1CQUFpQixFQUFFLG1CQUFpQixDQUFDLENBQUM7WUFDeEUsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELElBQUksY0FBYyxLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN4QyxPQUFPLEVBQUMsS0FBSyxFQUFFLGNBQWMsRUFBQyxDQUFDO1NBQ2xDO1FBRUQsSUFBTSxpQkFBaUIsR0FBRyx3QkFBd0IsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDbEYsSUFBTSxXQUFXLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlELElBQU0sZUFBZSxHQUFHLFlBQVksR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBRTFELE9BQU87WUFDSCxLQUFLLEVBQUUsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7U0FDekQsQ0FBQztJQUNOLENBQUMsQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLHdCQUF3QixDQUM3QixLQUFhLEVBQ2IsYUFBcUM7SUFBckMsOEJBQUEsRUFBQSxtQkFBcUM7SUFFckMsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUMxRSxDQUFDO0FBRUQsU0FBUyxvQkFBb0IsQ0FDekIsYUFBMEIsRUFDMUIsT0FBZSxFQUNmLGFBQXFCLEVBQ3JCLGFBQTJCO0lBSDNCLDhCQUFBLEVBQUEsa0JBQTBCO0lBRzFCLDhCQUFBLEVBQUEsbUJBQTJCO0lBRTNCLElBQU0sU0FBUyxHQUFHLElBQUksTUFBTSxDQUFJLGFBQWEsT0FBSSxDQUFDLENBQUM7SUFDbkQsSUFBTSxtQkFBbUIsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNqRSxJQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRTFELElBQU0sbUJBQW1CLEdBQ3JCLElBQUksQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsTUFBTSxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUV6RSxJQUFJLG1CQUFtQixFQUFFO1FBQ3JCLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQztLQUN6QjtJQUVELElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxPQUFPLENBQUMsTUFBTSxFQUFFO1FBQ3pDLElBQUksYUFBYSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxhQUFhLEVBQUU7WUFDdkQsT0FBTyx5QkFBeUIsQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDNUQ7UUFFRCxPQUFPLG1CQUFtQixLQUFLLGtCQUFrQjtZQUM3QyxDQUFDLENBQUMsYUFBYSxHQUFHLENBQUM7WUFDbkIsQ0FBQyxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7S0FDM0I7SUFFRCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQzVCLE9BQU8sQ0FBQyxDQUFDO0tBQ1o7SUFFRCxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUM7SUFFM0QsT0FBTyxhQUFhLEdBQUcsWUFBWSxDQUFDO0FBQ3hDLENBQUM7QUFFRCxTQUFTLHlCQUF5QixDQUFDLFFBQWdCLEVBQUUsT0FBZTtJQUNoRSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNyQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDNUIsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekM7S0FDSjtJQUVELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUMxQixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FDdEIsYUFBMEIsRUFDMUIsT0FBZSxFQUNmLGNBQXNCO0lBRnRCLDhCQUFBLEVBQUEsa0JBQTBCO0lBSTFCLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFaEYsSUFBSSxtQkFBbUIsRUFBRTtRQUNyQixPQUFPLENBQUMsQ0FBQztLQUNaO0lBRUQsSUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDOUQsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFFdkQsT0FBTyxTQUFTLEdBQUcsVUFBVSxDQUFDO0FBQ2xDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENIQVJfSFlQSEVOLFxuICAgIENIQVJfTk9fQlJFQUtfU1BBQ0UsXG4gICAgZ2V0RG9jdW1lbnRPclNoYWRvd1Jvb3QsXG4gICAgaXNOYXRpdmVGb2N1c2VkLFxuICAgIGlzU2FmYXJpLFxuICAgIHR1aUFzc2VydCxcbn0gZnJvbSAnQHRhaWdhLXVpL2Nkayc7XG5pbXBvcnQge1R1aVRleHRNYXNrUGlwZUhhbmRsZXJ9IGZyb20gJ0B0YWlnYS11aS9jb3JlL21hc2snO1xuaW1wb3J0IHtUdWlEZWNpbWFsU3ltYm9sfSBmcm9tICdAdGFpZ2EtdWkvY29yZS90eXBlcyc7XG5cbi8qKlxuICogVXNlZCB0byBmaW5pc2ggYSBudW1iZXIgd2l0aCB6ZXJvcyB0byBhIGdpdmVuIHByZWNpc2lvblxuICovXG5leHBvcnQgZnVuY3Rpb24gdHVpQ3JlYXRlQXV0b0NvcnJlY3RlZE51bWJlclBpcGUoXG4gICAgZGVjaW1hbExpbWl0OiBudW1iZXIgPSAwLFxuICAgIGRlY2ltYWxTeW1ib2w6IFR1aURlY2ltYWxTeW1ib2wgPSBgLGAsXG4gICAgdGhvdXNhbmRTeW1ib2w6IHN0cmluZyA9IENIQVJfTk9fQlJFQUtfU1BBQ0UsXG4gICAgbmF0aXZlSW5wdXQ/OiBIVE1MSW5wdXRFbGVtZW50IHwgbnVsbCxcbiAgICBhbGxvd05lZ2F0aXZlPzogYm9vbGVhbixcbiAgICBpc0lPUyA9IGZhbHNlLFxuKTogVHVpVGV4dE1hc2tQaXBlSGFuZGxlciB7XG4gICAgdHVpQXNzZXJ0LmFzc2VydChOdW1iZXIuaXNJbnRlZ2VyKGRlY2ltYWxMaW1pdCkpO1xuICAgIHR1aUFzc2VydC5hc3NlcnQoZGVjaW1hbExpbWl0ID49IDApO1xuXG4gICAgLy8gR3Vlc3MgZm9yIHdoaWNoIGJyb3dzZXIgSSBuZWVkIHRoaXMgOilcbiAgICBsZXQgcHJldmlvdXNDYXJldCA9IC0xO1xuICAgIGNvbnN0IHVubHVja3kgPSAoISFuYXRpdmVJbnB1dCAmJiBpc1NhZmFyaShuYXRpdmVJbnB1dCkpIHx8IGlzSU9TO1xuXG4gICAgaWYgKG5hdGl2ZUlucHV0ICYmIHVubHVja3kpIHtcbiAgICAgICAgbmF0aXZlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcihgYmVmb3JlaW5wdXRgLCAoKSA9PiB7XG4gICAgICAgICAgICBwcmV2aW91c0NhcmV0ID0gbmF0aXZlSW5wdXQuc2VsZWN0aW9uU3RhcnQgfHwgMDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIChjb25mb3JtZWRWYWx1ZSwgY29uZmlnKSA9PiB7XG4gICAgICAgIC8vIFJlbW92aW5nIGV2ZXJ5dGhpbmcgYnkgc2VsZWN0aW5nIGFuZCBwcmVzc2luZyAnLSdcbiAgICAgICAgaWYgKCFjb25mb3JtZWRWYWx1ZSAmJiBjb25maWcucmF3VmFsdWUgPT09IENIQVJfSFlQSEVOICYmIGFsbG93TmVnYXRpdmUpIHtcbiAgICAgICAgICAgIHJldHVybiBDSEFSX0hZUEhFTjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJlbW92ZSB0aGVzZSBoYWNrcyBhZnRlciB0ZXh0IG1hc2sgbGlicmFyeSBoYXMgY2hhbmdlZFxuICAgICAgICBpZiAobmF0aXZlSW5wdXQgJiYgdW5sdWNreSAmJiBpc05hdGl2ZUZvY3VzZWQobmF0aXZlSW5wdXQpKSB7XG4gICAgICAgICAgICBjb25zdCBjYXJldCA9IGNhbGN1bGF0ZVNhZmFyaUNhcmV0KFxuICAgICAgICAgICAgICAgIGNvbmZpZy5wcmV2aW91c0NvbmZvcm1lZFZhbHVlLFxuICAgICAgICAgICAgICAgIGNvbmZvcm1lZFZhbHVlLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzQ2FyZXQsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBuYXRpdmVJbnB1dC5zZXRTZWxlY3Rpb25SYW5nZShjYXJldCwgY2FyZXQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBuYXRpdmVJbnB1dCAmJlxuICAgICAgICAgICAgbmF0aXZlSW5wdXQub3duZXJEb2N1bWVudCAhPT0gZ2V0RG9jdW1lbnRPclNoYWRvd1Jvb3QobmF0aXZlSW5wdXQpICYmXG4gICAgICAgICAgICBpc05hdGl2ZUZvY3VzZWQobmF0aXZlSW5wdXQpICYmXG4gICAgICAgICAgICBjb25maWcuY3VycmVudENhcmV0UG9zaXRpb25cbiAgICAgICAgKSB7XG4gICAgICAgICAgICBjb25zdCByZWFsQ2FyZXRQb3NpdGlvbiA9XG4gICAgICAgICAgICAgICAgY29uZmlnLmN1cnJlbnRDYXJldFBvc2l0aW9uICtcbiAgICAgICAgICAgICAgICBjYWxjdWxhdGVDYXJldEdhcChcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnLnByZXZpb3VzQ29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZvcm1lZFZhbHVlLFxuICAgICAgICAgICAgICAgICAgICB0aG91c2FuZFN5bWJvbCxcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBuYXRpdmVJbnB1dC5zZXRTZWxlY3Rpb25SYW5nZShyZWFsQ2FyZXRQb3NpdGlvbiwgcmVhbENhcmV0UG9zaXRpb24pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZm9ybWVkVmFsdWUgPT09IGBgIHx8ICFkZWNpbWFsTGltaXQpIHtcbiAgICAgICAgICAgIHJldHVybiB7dmFsdWU6IGNvbmZvcm1lZFZhbHVlfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdpdGhEZWNpbWFsU3ltYm9sID0gYWRkRGVjaW1hbFN5bWJvbElmTmVlZGVkKGNvbmZvcm1lZFZhbHVlLCBkZWNpbWFsU3ltYm9sKTtcbiAgICAgICAgY29uc3QgZGVjaW1hbFBhcnQgPSB3aXRoRGVjaW1hbFN5bWJvbC5zcGxpdChkZWNpbWFsU3ltYm9sKVsxXTtcbiAgICAgICAgY29uc3QgemVyb1BhZGRpbmdTaXplID0gZGVjaW1hbExpbWl0IC0gZGVjaW1hbFBhcnQubGVuZ3RoO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB2YWx1ZTogd2l0aERlY2ltYWxTeW1ib2wgKyBgMGAucmVwZWF0KHplcm9QYWRkaW5nU2l6ZSksXG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuZnVuY3Rpb24gYWRkRGVjaW1hbFN5bWJvbElmTmVlZGVkKFxuICAgIHZhbHVlOiBzdHJpbmcsXG4gICAgZGVjaW1hbFN5bWJvbDogVHVpRGVjaW1hbFN5bWJvbCA9IGAsYCxcbik6IHN0cmluZyB7XG4gICAgcmV0dXJuICF2YWx1ZS5pbmNsdWRlcyhkZWNpbWFsU3ltYm9sKSA/IHZhbHVlICsgZGVjaW1hbFN5bWJvbCA6IHZhbHVlO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVTYWZhcmlDYXJldChcbiAgICBwcmV2aW91c1ZhbHVlOiBzdHJpbmcgPSBgYCxcbiAgICBjdXJyZW50OiBzdHJpbmcsXG4gICAgcHJldmlvdXNDYXJldDogbnVtYmVyLFxuICAgIGRlY2ltYWxTeW1ib2w6IHN0cmluZyA9IGAsYCxcbik6IG51bWJlciB7XG4gICAgY29uc3QgdGFpbFJlZ2V4ID0gbmV3IFJlZ0V4cChgJHtkZWNpbWFsU3ltYm9sfS4rYCk7XG4gICAgY29uc3QgcHJldmlvdXNXaXRob3V0VGFpbCA9IHByZXZpb3VzVmFsdWUucmVwbGFjZSh0YWlsUmVnZXgsIGBgKTtcbiAgICBjb25zdCBjdXJyZW50V2l0aG91dFRhaWwgPSBjdXJyZW50LnJlcGxhY2UodGFpbFJlZ2V4LCBgYCk7XG5cbiAgICBjb25zdCBwYXN0ZU9yQ3V0T3BlcmF0aW9uID1cbiAgICAgICAgTWF0aC5hYnMocHJldmlvdXNXaXRob3V0VGFpbC5sZW5ndGggLSBjdXJyZW50V2l0aG91dFRhaWwubGVuZ3RoKSA+IDI7XG5cbiAgICBpZiAocGFzdGVPckN1dE9wZXJhdGlvbikge1xuICAgICAgICByZXR1cm4gY3VycmVudC5sZW5ndGg7XG4gICAgfVxuXG4gICAgaWYgKHByZXZpb3VzVmFsdWUubGVuZ3RoID09PSBjdXJyZW50Lmxlbmd0aCkge1xuICAgICAgICBpZiAocHJldmlvdXNWYWx1ZS5pbmRleE9mKGRlY2ltYWxTeW1ib2wpIDw9IHByZXZpb3VzQ2FyZXQpIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxjdWxhdGVDaGFuZ2VkVGFpbEluZGV4KHByZXZpb3VzVmFsdWUsIGN1cnJlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByZXZpb3VzV2l0aG91dFRhaWwgPT09IGN1cnJlbnRXaXRob3V0VGFpbFxuICAgICAgICAgICAgPyBwcmV2aW91c0NhcmV0IC0gMVxuICAgICAgICAgICAgOiBwcmV2aW91c0NhcmV0ICsgMTtcbiAgICB9XG5cbiAgICBpZiAocHJldmlvdXNWYWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfVxuXG4gICAgY29uc3QgY2hhbmdlTGVuZ3RoID0gY3VycmVudC5sZW5ndGggLSBwcmV2aW91c1ZhbHVlLmxlbmd0aDtcblxuICAgIHJldHVybiBwcmV2aW91c0NhcmV0ICsgY2hhbmdlTGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDaGFuZ2VkVGFpbEluZGV4KHByZXZpb3VzOiBzdHJpbmcsIGN1cnJlbnQ6IHN0cmluZyk6IG51bWJlciB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJyZW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChwcmV2aW91c1tpXSAhPT0gY3VycmVudFtpXSkge1xuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRbaV0gPT09IGAwYCA/IGkgOiBpICsgMTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50Lmxlbmd0aDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQ2FyZXRHYXAoXG4gICAgcHJldmlvdXNWYWx1ZTogc3RyaW5nID0gYGAsXG4gICAgY3VycmVudDogc3RyaW5nLFxuICAgIHRob3VzYW5kU3ltYm9sOiBzdHJpbmcsXG4pOiBudW1iZXIge1xuICAgIGNvbnN0IHBhc3RlT3JDdXRPcGVyYXRpb24gPSBNYXRoLmFicyhwcmV2aW91c1ZhbHVlLmxlbmd0aCAtIGN1cnJlbnQubGVuZ3RoKSA+IDI7XG5cbiAgICBpZiAocGFzdGVPckN1dE9wZXJhdGlvbikge1xuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBjb25zdCB3ZXJlU3BhY2VzID0gcHJldmlvdXNWYWx1ZS5zcGxpdCh0aG91c2FuZFN5bWJvbCkubGVuZ3RoO1xuICAgIGNvbnN0IG5vd1NwYWNlcyA9IGN1cnJlbnQuc3BsaXQodGhvdXNhbmRTeW1ib2wpLmxlbmd0aDtcblxuICAgIHJldHVybiBub3dTcGFjZXMgLSB3ZXJlU3BhY2VzO1xufVxuIl19