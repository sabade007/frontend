import { __decorate, __extends, __param, __read } from "tslib";
import { Directive, ElementRef, Inject, Input, OnDestroy, Optional, Renderer2, Self, } from '@angular/core';
import { TuiActiveZoneDirective, tuiDefaultProp, TuiDestroyService, TuiHoveredService, TuiObscuredService, TuiParentsScrollService, tuiRequiredSetter, } from '@taiga-ui/cdk';
import { AbstractTuiHint } from '@taiga-ui/core/abstract';
import { DESCRIBED_BY } from '@taiga-ui/core/directives/described-by';
import { TuiHintService } from '@taiga-ui/core/services';
import { combineLatest, of, Subject } from 'rxjs';
import { delay, distinctUntilChanged, map, startWith, switchMap, take, takeUntil, } from 'rxjs/operators';
import { TUI_HINT_OPTIONS } from './hint-options';
export var HINT_HOVERED_CLASS = '_hint_hovered';
var TuiHintDirective = /** @class */ (function (_super) {
    __extends(TuiHintDirective, _super);
    function TuiHintDirective(renderer, elementRef, hintService, destroy$, obscured$, hoveredService, activeZone, options) {
        var _this = _super.call(this, elementRef, hintService, activeZone, options) || this;
        _this.renderer = renderer;
        _this.options = options;
        _this.tuiHintShowDelay = _this.options.tuiHintShowDelay;
        _this.tuiHintHideDelay = _this.options.tuiHintHideDelay;
        _this.tuiHintHost = null;
        _this.componentHovered$ = new Subject();
        // @bad TODO: Use private provider
        combineLatest(hoveredService.createHovered$(elementRef.nativeElement), _this.componentHovered$.pipe(startWith(false)))
            .pipe(map(function (_a) {
            var _b = __read(_a, 2), directiveHovered = _b[0], componentHovered = _b[1];
            return directiveHovered || componentHovered;
        }), switchMap(function (visible) {
            _this.toggleClass(visible);
            return of(visible).pipe(delay(visible ? _this.tuiHintShowDelay : _this.tuiHintHideDelay));
        }), switchMap(function (visible) {
            return visible && _this.mode !== 'overflow'
                ? obscured$.pipe(map(function (obscured) { return !obscured; }), take(2))
                : of(visible);
        }), distinctUntilChanged(), takeUntil(destroy$))
            .subscribe(function (visible) {
            if (visible) {
                _this.showTooltip();
            }
            else {
                _this.hideTooltip();
            }
        });
        _this.hintService.register(_this);
        return _this;
    }
    Object.defineProperty(TuiHintDirective.prototype, "tuiHint", {
        // TODO: 3.0 Remove null
        set: function (value) {
            if (!value) {
                this.hideTooltip();
                this.content = '';
                return;
            }
            this.content = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiHintDirective.prototype, "id", {
        get: function () {
            return this.tuiHintId ? this.tuiHintId + DESCRIBED_BY : null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiHintDirective.prototype, "host", {
        get: function () {
            return this.tuiHintHost ? this.tuiHintHost : this.elementRef.nativeElement;
        },
        enumerable: true,
        configurable: true
    });
    TuiHintDirective.prototype.getElementClientRect = function () {
        return this.host.getBoundingClientRect();
    };
    TuiHintDirective.prototype.ngOnDestroy = function () {
        this.hintService.unregister(this);
    };
    TuiHintDirective.prototype.showTooltip = function () {
        if (this.content === '') {
            return;
        }
        this.toggleClass(true);
        this.hintService.add(this);
    };
    TuiHintDirective.prototype.hideTooltip = function () {
        this.toggleClass(false);
        this.hintService.remove(this);
    };
    TuiHintDirective.prototype.toggleClass = function (add) {
        if (add) {
            this.renderer.addClass(this.elementRef.nativeElement, HINT_HOVERED_CLASS);
        }
        else {
            this.renderer.removeClass(this.elementRef.nativeElement, HINT_HOVERED_CLASS);
        }
    };
    TuiHintDirective.ctorParameters = function () { return [
        { type: Renderer2, decorators: [{ type: Inject, args: [Renderer2,] }] },
        { type: ElementRef, decorators: [{ type: Inject, args: [ElementRef,] }] },
        { type: TuiHintService, decorators: [{ type: Inject, args: [TuiHintService,] }] },
        { type: TuiDestroyService, decorators: [{ type: Inject, args: [TuiDestroyService,] }] },
        { type: TuiObscuredService, decorators: [{ type: Inject, args: [TuiObscuredService,] }, { type: Self }] },
        { type: TuiHoveredService, decorators: [{ type: Inject, args: [TuiHoveredService,] }] },
        { type: TuiActiveZoneDirective, decorators: [{ type: Optional }, { type: Inject, args: [TuiActiveZoneDirective,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [TUI_HINT_OPTIONS,] }] }
    ]; };
    __decorate([
        Input()
    ], TuiHintDirective.prototype, "tuiHintId", void 0);
    __decorate([
        Input(),
        tuiDefaultProp()
    ], TuiHintDirective.prototype, "tuiHintShowDelay", void 0);
    __decorate([
        Input(),
        tuiDefaultProp()
    ], TuiHintDirective.prototype, "tuiHintHideDelay", void 0);
    __decorate([
        Input(),
        tuiDefaultProp()
    ], TuiHintDirective.prototype, "tuiHintHost", void 0);
    __decorate([
        Input(),
        tuiRequiredSetter()
    ], TuiHintDirective.prototype, "tuiHint", null);
    TuiHintDirective = __decorate([
        Directive({
            selector: '[tuiHint]:not(ng-container)',
            providers: [TuiObscuredService, TuiParentsScrollService, TuiDestroyService],
        }),
        __param(0, Inject(Renderer2)),
        __param(1, Inject(ElementRef)),
        __param(2, Inject(TuiHintService)),
        __param(3, Inject(TuiDestroyService)),
        __param(4, Inject(TuiObscuredService)),
        __param(4, Self()),
        __param(5, Inject(TuiHoveredService)),
        __param(6, Optional()),
        __param(6, Inject(TuiActiveZoneDirective)),
        __param(7, Inject(TUI_HINT_OPTIONS))
    ], TuiHintDirective);
    return TuiHintDirective;
}(AbstractTuiHint));
export { TuiHintDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGludC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkvY29yZS9kaXJlY3RpdmVzL2hpbnQvIiwic291cmNlcyI6WyJoaW50LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxVQUFVLEVBQ1YsTUFBTSxFQUNOLEtBQUssRUFDTCxTQUFTLEVBQ1QsUUFBUSxFQUNSLFNBQVMsRUFDVCxJQUFJLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNILHNCQUFzQixFQUN0QixjQUFjLEVBQ2QsaUJBQWlCLEVBQ2pCLGlCQUFpQixFQUNqQixrQkFBa0IsRUFDbEIsdUJBQXVCLEVBQ3ZCLGlCQUFpQixHQUNwQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDeEQsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLHdDQUF3QyxDQUFDO0FBQ3BFLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUV2RCxPQUFPLEVBQUMsYUFBYSxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUNILEtBQUssRUFDTCxvQkFBb0IsRUFDcEIsR0FBRyxFQUNILFNBQVMsRUFDVCxTQUFTLEVBQ1QsSUFBSSxFQUNKLFNBQVMsR0FDWixNQUFNLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBQyxnQkFBZ0IsRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRSxNQUFNLENBQUMsSUFBTSxrQkFBa0IsR0FBRyxlQUFlLENBQUM7QUFNbEQ7SUFBc0Msb0NBQWU7SUFnQ2pELDBCQUN3QyxRQUFtQixFQUNuQyxVQUFtQyxFQUMvQixXQUEyQixFQUVuRCxRQUEyQixFQUczQixTQUE2QixFQUNGLGNBQWlDLEVBRzVELFVBQXlDLEVBQ0ksT0FBdUI7UUFieEUsWUFlSSxrQkFBTSxV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QUU3QixNQUFNLFNBQUMsZ0JBQWdCOztJQTNDNUI7UUFEQyxLQUFLLEVBQUU7dURBQ1c7SUFJbkI7UUFGQyxLQUFLLEVBQUU7UUFDUCxjQUFjLEVBQUU7OERBQ29FO0lBSXJGO1FBRkMsS0FBSyxFQUFFO1FBQ1AsY0FBYyxFQUFFOzhEQUNvRTtJQUlyRjtRQUZDLEtBQUssRUFBRTtRQUNQLGNBQWMsRUFBRTt5REFDc0I7SUFLdkM7UUFGQyxLQUFLLEVBQUU7UUFDUCxpQkFBaUIsRUFBRTttREFVbkI7SUE1QlEsZ0JBQWdCO1FBSjVCLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSw2QkFBNkI7WUFDdkMsU0FBUyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsdUJBQXVCLEVBQUUsaUJBQWlCLENBQUM7U0FDOUUsQ0FBQztRQWtDTyxXQUFBLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUNqQixXQUFBLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUNsQixXQUFBLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQTtRQUN0QixXQUFBLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO1FBRXpCLFdBQUEsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUE7UUFDMUIsV0FBQSxJQUFJLEVBQUUsQ0FBQTtRQUVOLFdBQUEsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7UUFDekIsV0FBQSxRQUFRLEVBQUUsQ0FBQTtRQUNWLFdBQUEsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUE7UUFFOUIsV0FBQSxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtPQTdDcEIsZ0JBQWdCLENBNkg1QjtJQUFELHVCQUFDO0NBQUEsQUE3SEQsQ0FBc0MsZUFBZSxHQTZIcEQ7U0E3SFksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBEaXJlY3RpdmUsXG4gICAgRWxlbWVudFJlZixcbiAgICBJbmplY3QsXG4gICAgSW5wdXQsXG4gICAgT25EZXN0cm95LFxuICAgIE9wdGlvbmFsLFxuICAgIFJlbmRlcmVyMixcbiAgICBTZWxmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSxcbiAgICB0dWlEZWZhdWx0UHJvcCxcbiAgICBUdWlEZXN0cm95U2VydmljZSxcbiAgICBUdWlIb3ZlcmVkU2VydmljZSxcbiAgICBUdWlPYnNjdXJlZFNlcnZpY2UsXG4gICAgVHVpUGFyZW50c1Njcm9sbFNlcnZpY2UsXG4gICAgdHVpUmVxdWlyZWRTZXR0ZXIsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsnO1xuaW1wb3J0IHtBYnN0cmFjdFR1aUhpbnR9IGZyb20gJ0B0YWlnYS11aS9jb3JlL2Fic3RyYWN0JztcbmltcG9ydCB7REVTQ1JJQkVEX0JZfSBmcm9tICdAdGFpZ2EtdWkvY29yZS9kaXJlY3RpdmVzL2Rlc2NyaWJlZC1ieSc7XG5pbXBvcnQge1R1aUhpbnRTZXJ2aWNlfSBmcm9tICdAdGFpZ2EtdWkvY29yZS9zZXJ2aWNlcyc7XG5pbXBvcnQge1BvbHltb3JwaGV1c0NvbnRlbnR9IGZyb20gJ0B0aW5rb2ZmL25nLXBvbHltb3JwaGV1cyc7XG5pbXBvcnQge2NvbWJpbmVMYXRlc3QsIG9mLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gICAgZGVsYXksXG4gICAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gICAgbWFwLFxuICAgIHN0YXJ0V2l0aCxcbiAgICBzd2l0Y2hNYXAsXG4gICAgdGFrZSxcbiAgICB0YWtlVW50aWwsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtUVUlfSElOVF9PUFRJT05TLCBUdWlIaW50T3B0aW9uc30gZnJvbSAnLi9oaW50LW9wdGlvbnMnO1xuXG5leHBvcnQgY29uc3QgSElOVF9IT1ZFUkVEX0NMQVNTID0gJ19oaW50X2hvdmVyZWQnO1xuXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1t0dWlIaW50XTpub3QobmctY29udGFpbmVyKScsXG4gICAgcHJvdmlkZXJzOiBbVHVpT2JzY3VyZWRTZXJ2aWNlLCBUdWlQYXJlbnRzU2Nyb2xsU2VydmljZSwgVHVpRGVzdHJveVNlcnZpY2VdLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlIaW50RGlyZWN0aXZlIGV4dGVuZHMgQWJzdHJhY3RUdWlIaW50IGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBASW5wdXQoKVxuICAgIHR1aUhpbnRJZD86IHN0cmluZztcblxuICAgIEBJbnB1dCgpXG4gICAgQHR1aURlZmF1bHRQcm9wKClcbiAgICB0dWlIaW50U2hvd0RlbGF5OiBUdWlIaW50T3B0aW9uc1sndHVpSGludFNob3dEZWxheSddID0gdGhpcy5vcHRpb25zLnR1aUhpbnRTaG93RGVsYXk7XG5cbiAgICBASW5wdXQoKVxuICAgIEB0dWlEZWZhdWx0UHJvcCgpXG4gICAgdHVpSGludEhpZGVEZWxheTogVHVpSGludE9wdGlvbnNbJ3R1aUhpbnRIaWRlRGVsYXknXSA9IHRoaXMub3B0aW9ucy50dWlIaW50SGlkZURlbGF5O1xuXG4gICAgQElucHV0KClcbiAgICBAdHVpRGVmYXVsdFByb3AoKVxuICAgIHR1aUhpbnRIb3N0OiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xuXG4gICAgLy8gVE9ETzogMy4wIFJlbW92ZSBudWxsXG4gICAgQElucHV0KClcbiAgICBAdHVpUmVxdWlyZWRTZXR0ZXIoKVxuICAgIHNldCB0dWlIaW50KHZhbHVlOiBQb2x5bW9ycGhldXNDb250ZW50IHwgbnVsbCkge1xuICAgICAgICBpZiAoIXZhbHVlKSB7XG4gICAgICAgICAgICB0aGlzLmhpZGVUb29sdGlwKCk7XG4gICAgICAgICAgICB0aGlzLmNvbnRlbnQgPSAnJztcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb250ZW50ID0gdmFsdWU7XG4gICAgfVxuXG4gICAgcmVhZG9ubHkgY29tcG9uZW50SG92ZXJlZCQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoUmVuZGVyZXIyKSBwcml2YXRlIHJlYWRvbmx5IHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgICAgIEBJbmplY3QoRWxlbWVudFJlZikgZWxlbWVudFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgICAgIEBJbmplY3QoVHVpSGludFNlcnZpY2UpIGhpbnRTZXJ2aWNlOiBUdWlIaW50U2VydmljZSxcbiAgICAgICAgQEluamVjdChUdWlEZXN0cm95U2VydmljZSlcbiAgICAgICAgZGVzdHJveSQ6IFR1aURlc3Ryb3lTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KFR1aU9ic2N1cmVkU2VydmljZSlcbiAgICAgICAgQFNlbGYoKVxuICAgICAgICBvYnNjdXJlZCQ6IFR1aU9ic2N1cmVkU2VydmljZSxcbiAgICAgICAgQEluamVjdChUdWlIb3ZlcmVkU2VydmljZSkgaG92ZXJlZFNlcnZpY2U6IFR1aUhvdmVyZWRTZXJ2aWNlLFxuICAgICAgICBAT3B0aW9uYWwoKVxuICAgICAgICBASW5qZWN0KFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUpXG4gICAgICAgIGFjdGl2ZVpvbmU6IFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUgfCBudWxsLFxuICAgICAgICBASW5qZWN0KFRVSV9ISU5UX09QVElPTlMpIHByb3RlY3RlZCByZWFkb25seSBvcHRpb25zOiBUdWlIaW50T3B0aW9ucyxcbiAgICApIHtcbiAgICAgICAgc3VwZXIoZWxlbWVudFJlZiwgaGludFNlcnZpY2UsIGFjdGl2ZVpvbmUsIG9wdGlvbnMpO1xuXG4gICAgICAgIC8vIEBiYWQgVE9ETzogVXNlIHByaXZhdGUgcHJvdmlkZXJcbiAgICAgICAgY29tYmluZUxhdGVzdChcbiAgICAgICAgICAgIGhvdmVyZWRTZXJ2aWNlLmNyZWF0ZUhvdmVyZWQkKGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCksXG4gICAgICAgICAgICB0aGlzLmNvbXBvbmVudEhvdmVyZWQkLnBpcGUoc3RhcnRXaXRoKGZhbHNlKSksXG4gICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgICAgICAgKFtkaXJlY3RpdmVIb3ZlcmVkLCBjb21wb25lbnRIb3ZlcmVkXSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGl2ZUhvdmVyZWQgfHwgY29tcG9uZW50SG92ZXJlZCxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCh2aXNpYmxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50b2dnbGVDbGFzcyh2aXNpYmxlKTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YodmlzaWJsZSkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5KHZpc2libGUgPyB0aGlzLnR1aUhpbnRTaG93RGVsYXkgOiB0aGlzLnR1aUhpbnRIaWRlRGVsYXkpLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcCh2aXNpYmxlID0+XG4gICAgICAgICAgICAgICAgICAgIHZpc2libGUgJiYgdGhpcy5tb2RlICE9PSAnb3ZlcmZsb3cnXG4gICAgICAgICAgICAgICAgICAgICAgICA/IG9ic2N1cmVkJC5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKG9ic2N1cmVkID0+ICFvYnNjdXJlZCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWtlKDIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICA6IG9mKHZpc2libGUpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICAgICAgICB0YWtlVW50aWwoZGVzdHJveSQpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSh2aXNpYmxlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodmlzaWJsZSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dUb29sdGlwKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlVG9vbHRpcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaGludFNlcnZpY2UucmVnaXN0ZXIodGhpcyk7XG4gICAgfVxuXG4gICAgZ2V0IGlkKCk6IHN0cmluZyB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy50dWlIaW50SWQgPyB0aGlzLnR1aUhpbnRJZCArIERFU0NSSUJFRF9CWSA6IG51bGw7XG4gICAgfVxuXG4gICAgZ2V0IGhvc3QoKTogSFRNTEVsZW1lbnQge1xuICAgICAgICByZXR1cm4gdGhpcy50dWlIaW50SG9zdCA/IHRoaXMudHVpSGludEhvc3QgOiB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcbiAgICB9XG5cbiAgICBnZXRFbGVtZW50Q2xpZW50UmVjdCgpOiBDbGllbnRSZWN0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaG9zdC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oaW50U2VydmljZS51bnJlZ2lzdGVyKHRoaXMpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzaG93VG9vbHRpcCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuY29udGVudCA9PT0gJycpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudG9nZ2xlQ2xhc3ModHJ1ZSk7XG4gICAgICAgIHRoaXMuaGludFNlcnZpY2UuYWRkKHRoaXMpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBoaWRlVG9vbHRpcCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy50b2dnbGVDbGFzcyhmYWxzZSk7XG4gICAgICAgIHRoaXMuaGludFNlcnZpY2UucmVtb3ZlKHRoaXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdG9nZ2xlQ2xhc3MoYWRkOiBib29sZWFuKTogdm9pZCB7XG4gICAgICAgIGlmIChhZGQpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIEhJTlRfSE9WRVJFRF9DTEFTUyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBISU5UX0hPVkVSRURfQ0xBU1MpO1xuICAgICAgICB9XG4gICAgfVxufVxuIl19