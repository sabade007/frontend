import { CHAR_HYPHEN, CHAR_NO_BREAK_SPACE, getDocumentOrShadowRoot, isNativeFocused, isSafari, tuiAssert, } from '@taiga-ui/cdk';
/**
 * Used to finish a number with zeros to a given precision
 */
export function tuiCreateAutoCorrectedNumberPipe(decimalLimit = 0, decimalSymbol = `,`, thousandSymbol = CHAR_NO_BREAK_SPACE, nativeInput, allowNegative, isIOS = false) {
    tuiAssert.assert(Number.isInteger(decimalLimit));
    tuiAssert.assert(decimalLimit >= 0);
    // Guess for which browser I need this :)
    let previousCaret = -1;
    const unlucky = (!!nativeInput && isSafari(nativeInput)) || isIOS;
    if (nativeInput && unlucky) {
        nativeInput.addEventListener(`beforeinput`, () => {
            previousCaret = nativeInput.selectionStart || 0;
        });
    }
    return (conformedValue, config) => {
        // Removing everything by selecting and pressing '-'
        if (!conformedValue && config.rawValue === CHAR_HYPHEN && allowNegative) {
            return CHAR_HYPHEN;
        }
        // remove these hacks after text mask library has changed
        if (nativeInput && unlucky && isNativeFocused(nativeInput)) {
            const caret = calculateSafariCaret(config.previousConformedValue, conformedValue, previousCaret);
            setTimeout(() => {
                nativeInput.setSelectionRange(caret, caret);
            });
        }
        if (nativeInput &&
            nativeInput.ownerDocument !== getDocumentOrShadowRoot(nativeInput) &&
            isNativeFocused(nativeInput) &&
            config.currentCaretPosition) {
            const realCaretPosition = config.currentCaretPosition +
                calculateCaretGap(config.previousConformedValue, conformedValue, thousandSymbol);
            setTimeout(() => {
                nativeInput.setSelectionRange(realCaretPosition, realCaretPosition);
            });
        }
        if (conformedValue === `` || !decimalLimit) {
            return { value: conformedValue };
        }
        const withDecimalSymbol = addDecimalSymbolIfNeeded(conformedValue, decimalSymbol);
        const decimalPart = withDecimalSymbol.split(decimalSymbol)[1];
        const zeroPaddingSize = decimalLimit - decimalPart.length;
        return {
            value: withDecimalSymbol + `0`.repeat(zeroPaddingSize),
        };
    };
}
function addDecimalSymbolIfNeeded(value, decimalSymbol = `,`) {
    return !value.includes(decimalSymbol) ? value + decimalSymbol : value;
}
function calculateSafariCaret(previousValue = ``, current, previousCaret, decimalSymbol = `,`) {
    const tailRegex = new RegExp(`${decimalSymbol}.+`);
    const previousWithoutTail = previousValue.replace(tailRegex, ``);
    const currentWithoutTail = current.replace(tailRegex, ``);
    const pasteOrCutOperation = Math.abs(previousWithoutTail.length - currentWithoutTail.length) > 2;
    if (pasteOrCutOperation) {
        return current.length;
    }
    if (previousValue.length === current.length) {
        if (previousValue.indexOf(decimalSymbol) <= previousCaret) {
            return calculateChangedTailIndex(previousValue, current);
        }
        return previousWithoutTail === currentWithoutTail
            ? previousCaret - 1
            : previousCaret + 1;
    }
    if (previousValue.length === 0) {
        return 1;
    }
    const changeLength = current.length - previousValue.length;
    return previousCaret + changeLength;
}
function calculateChangedTailIndex(previous, current) {
    for (let i = 0; i < current.length; i++) {
        if (previous[i] !== current[i]) {
            return current[i] === `0` ? i : i + 1;
        }
    }
    return current.length;
}
function calculateCaretGap(previousValue = ``, current, thousandSymbol) {
    const pasteOrCutOperation = Math.abs(previousValue.length - current.length) > 2;
    if (pasteOrCutOperation) {
        return 0;
    }
    const wereSpaces = previousValue.split(thousandSymbol).length;
    const nowSpaces = current.split(thousandSymbol).length;
    return nowSpaces - wereSpaces;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkvY29yZS91dGlscy9tYXNrLyIsInNvdXJjZXMiOlsiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFdBQVcsRUFDWCxtQkFBbUIsRUFDbkIsdUJBQXVCLEVBQ3ZCLGVBQWUsRUFDZixRQUFRLEVBQ1IsU0FBUyxHQUNaLE1BQU0sZUFBZSxDQUFDO0FBSXZCOztHQUVHO0FBQ0gsTUFBTSxVQUFVLGdDQUFnQyxDQUM1QyxlQUF1QixDQUFDLEVBQ3hCLGdCQUFrQyxHQUFHLEVBQ3JDLGlCQUF5QixtQkFBbUIsRUFDNUMsV0FBcUMsRUFDckMsYUFBdUIsRUFDdkIsS0FBSyxHQUFHLEtBQUs7SUFFYixTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztJQUNqRCxTQUFTLENBQUMsTUFBTSxDQUFDLFlBQVksSUFBSSxDQUFDLENBQUMsQ0FBQztJQUVwQyx5Q0FBeUM7SUFDekMsSUFBSSxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdkIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQztJQUVsRSxJQUFJLFdBQVcsSUFBSSxPQUFPLEVBQUU7UUFDeEIsV0FBVyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7WUFDN0MsYUFBYSxHQUFHLFdBQVcsQ0FBQyxjQUFjLElBQUksQ0FBQyxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO0tBQ047SUFFRCxPQUFPLENBQUMsY0FBYyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQzlCLG9EQUFvRDtRQUNwRCxJQUFJLENBQUMsY0FBYyxJQUFJLE1BQU0sQ0FBQyxR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QU0sQ0FBQztJQUV2RCxPQUFPLFNBQVMsR0FBRyxVQUFVLENBQUM7QUFDbEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ0hBUl9IWVBIRU4sXG4gICAgQ0hBUl9OT19CUkVBS19TUEFDRSxcbiAgICBnZXREb2N1bWVudE9yU2hhZG93Um9vdCxcbiAgICBpc05hdGl2ZUZvY3VzZWQsXG4gICAgaXNTYWZhcmksXG4gICAgdHVpQXNzZXJ0LFxufSBmcm9tICdAdGFpZ2EtdWkvY2RrJztcbmltcG9ydCB7VHVpVGV4dE1hc2tQaXBlSGFuZGxlcn0gZnJvbSAnQHRhaWdhLXVpL2NvcmUvbWFzayc7XG5pbXBvcnQge1R1aURlY2ltYWxTeW1ib2x9IGZyb20gJ0B0YWlnYS11aS9jb3JlL3R5cGVzJztcblxuLyoqXG4gKiBVc2VkIHRvIGZpbmlzaCBhIG51bWJlciB3aXRoIHplcm9zIHRvIGEgZ2l2ZW4gcHJlY2lzaW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0dWlDcmVhdGVBdXRvQ29ycmVjdGVkTnVtYmVyUGlwZShcbiAgICBkZWNpbWFsTGltaXQ6IG51bWJlciA9IDAsXG4gICAgZGVjaW1hbFN5bWJvbDogVHVpRGVjaW1hbFN5bWJvbCA9IGAsYCxcbiAgICB0aG91c2FuZFN5bWJvbDogc3RyaW5nID0gQ0hBUl9OT19CUkVBS19TUEFDRSxcbiAgICBuYXRpdmVJbnB1dD86IEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsLFxuICAgIGFsbG93TmVnYXRpdmU/OiBib29sZWFuLFxuICAgIGlzSU9TID0gZmFsc2UsXG4pOiBUdWlUZXh0TWFza1BpcGVIYW5kbGVyIHtcbiAgICB0dWlBc3NlcnQuYXNzZXJ0KE51bWJlci5pc0ludGVnZXIoZGVjaW1hbExpbWl0KSk7XG4gICAgdHVpQXNzZXJ0LmFzc2VydChkZWNpbWFsTGltaXQgPj0gMCk7XG5cbiAgICAvLyBHdWVzcyBmb3Igd2hpY2ggYnJvd3NlciBJIG5lZWQgdGhpcyA6KVxuICAgIGxldCBwcmV2aW91c0NhcmV0ID0gLTE7XG4gICAgY29uc3QgdW5sdWNreSA9ICghIW5hdGl2ZUlucHV0ICYmIGlzU2FmYXJpKG5hdGl2ZUlucHV0KSkgfHwgaXNJT1M7XG5cbiAgICBpZiAobmF0aXZlSW5wdXQgJiYgdW5sdWNreSkge1xuICAgICAgICBuYXRpdmVJbnB1dC5hZGRFdmVudExpc3RlbmVyKGBiZWZvcmVpbnB1dGAsICgpID0+IHtcbiAgICAgICAgICAgIHByZXZpb3VzQ2FyZXQgPSBuYXRpdmVJbnB1dC5zZWxlY3Rpb25TdGFydCB8fCAwO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gKGNvbmZvcm1lZFZhbHVlLCBjb25maWcpID0+IHtcbiAgICAgICAgLy8gUmVtb3ZpbmcgZXZlcnl0aGluZyBieSBzZWxlY3RpbmcgYW5kIHByZXNzaW5nICctJ1xuICAgICAgICBpZiAoIWNvbmZvcm1lZFZhbHVlICYmIGNvbmZpZy5yYXdWYWx1ZSA9PT0gQ0hBUl9IWVBIRU4gJiYgYWxsb3dOZWdhdGl2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIENIQVJfSFlQSEVOO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gcmVtb3ZlIHRoZXNlIGhhY2tzIGFmdGVyIHRleHQgbWFzayBsaWJyYXJ5IGhhcyBjaGFuZ2VkXG4gICAgICAgIGlmIChuYXRpdmVJbnB1dCAmJiB1bmx1Y2t5ICYmIGlzTmF0aXZlRm9jdXNlZChuYXRpdmVJbnB1dCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNhcmV0ID0gY2FsY3VsYXRlU2FmYXJpQ2FyZXQoXG4gICAgICAgICAgICAgICAgY29uZmlnLnByZXZpb3VzQ29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgY29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgcHJldmlvdXNDYXJldCxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG5hdGl2ZUlucHV0LnNldFNlbGVjdGlvblJhbmdlKGNhcmV0LCBjYXJldCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIG5hdGl2ZUlucHV0ICYmXG4gICAgICAgICAgICBuYXRpdmVJbnB1dC5vd25lckRvY3VtZW50ICE9PSBnZXREb2N1bWVudE9yU2hhZG93Um9vdChuYXRpdmVJbnB1dCkgJiZcbiAgICAgICAgICAgIGlzTmF0aXZlRm9jdXNlZChuYXRpdmVJbnB1dCkgJiZcbiAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50Q2FyZXRQb3NpdGlvblxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWxDYXJldFBvc2l0aW9uID1cbiAgICAgICAgICAgICAgICBjb25maWcuY3VycmVudENhcmV0UG9zaXRpb24gK1xuICAgICAgICAgICAgICAgIGNhbGN1bGF0ZUNhcmV0R2FwKFxuICAgICAgICAgICAgICAgICAgICBjb25maWcucHJldmlvdXNDb25mb3JtZWRWYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgY29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIHRob3VzYW5kU3ltYm9sLFxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG5hdGl2ZUlucHV0LnNldFNlbGVjdGlvblJhbmdlKHJlYWxDYXJldFBvc2l0aW9uLCByZWFsQ2FyZXRQb3NpdGlvbik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25mb3JtZWRWYWx1ZSA9PT0gYGAgfHwgIWRlY2ltYWxMaW1pdCkge1xuICAgICAgICAgICAgcmV0dXJuIHt2YWx1ZTogY29uZm9ybWVkVmFsdWV9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgd2l0aERlY2ltYWxTeW1ib2wgPSBhZGREZWNpbWFsU3ltYm9sSWZOZWVkZWQoY29uZm9ybWVkVmFsdWUsIGRlY2ltYWxTeW1ib2wpO1xuICAgICAgICBjb25zdCBkZWNpbWFsUGFydCA9IHdpdGhEZWNpbWFsU3ltYm9sLnNwbGl0KGRlY2ltYWxTeW1ib2wpWzFdO1xuICAgICAgICBjb25zdCB6ZXJvUGFkZGluZ1NpemUgPSBkZWNpbWFsTGltaXQgLSBkZWNpbWFsUGFydC5sZW5ndGg7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZhbHVlOiB3aXRoRGVjaW1hbFN5bWJvbCArIGAwYC5yZXBlYXQoemVyb1BhZGRpbmdTaXplKSxcbiAgICAgICAgfTtcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBhZGREZWNpbWFsU3ltYm9sSWZOZWVkZWQoXG4gICAgdmFsdWU6IHN0cmluZyxcbiAgICBkZWNpbWFsU3ltYm9sOiBUdWlEZWNpbWFsU3ltYm9sID0gYCxgLFxuKTogc3RyaW5nIHtcbiAgICByZXR1cm4gIXZhbHVlLmluY2x1ZGVzKGRlY2ltYWxTeW1ib2wpID8gdmFsdWUgKyBkZWNpbWFsU3ltYm9sIDogdmFsdWU7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVNhZmFyaUNhcmV0KFxuICAgIHByZXZpb3VzVmFsdWU6IHN0cmluZyA9IGBgLFxuICAgIGN1cnJlbnQ6IHN0cmluZyxcbiAgICBwcmV2aW91c0NhcmV0OiBudW1iZXIsXG4gICAgZGVjaW1hbFN5bWJvbDogc3RyaW5nID0gYCxgLFxuKTogbnVtYmVyIHtcbiAgICBjb25zdCB0YWlsUmVnZXggPSBuZXcgUmVnRXhwKGAke2RlY2ltYWxTeW1ib2x9LitgKTtcbiAgICBjb25zdCBwcmV2aW91c1dpdGhvdXRUYWlsID0gcHJldmlvdXNWYWx1ZS5yZXBsYWNlKHRhaWxSZWdleCwgYGApO1xuICAgIGNvbnN0IGN1cnJlbnRXaXRob3V0VGFpbCA9IGN1cnJlbnQucmVwbGFjZSh0YWlsUmVnZXgsIGBgKTtcblxuICAgIGNvbnN0IHBhc3RlT3JDdXRPcGVyYXRpb24gPVxuICAgICAgICBNYXRoLmFicyhwcmV2aW91c1dpdGhvdXRUYWlsLmxlbmd0aCAtIGN1cnJlbnRXaXRob3V0VGFpbC5sZW5ndGgpID4gMjtcblxuICAgIGlmIChwYXN0ZU9yQ3V0T3BlcmF0aW9uKSB7XG4gICAgICAgIHJldHVybiBjdXJyZW50Lmxlbmd0aDtcbiAgICB9XG5cbiAgICBpZiAocHJldmlvdXNWYWx1ZS5sZW5ndGggPT09IGN1cnJlbnQubGVuZ3RoKSB7XG4gICAgICAgIGlmIChwcmV2aW91c1ZhbHVlLmluZGV4T2YoZGVjaW1hbFN5bWJvbCkgPD0gcHJldmlvdXNDYXJldCkge1xuICAgICAgICAgICAgcmV0dXJuIGNhbGN1bGF0ZUNoYW5nZWRUYWlsSW5kZXgocHJldmlvdXNWYWx1ZSwgY3VycmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJldmlvdXNXaXRob3V0VGFpbCA9PT0gY3VycmVudFdpdGhvdXRUYWlsXG4gICAgICAgICAgICA/IHByZXZpb3VzQ2FyZXQgLSAxXG4gICAgICAgICAgICA6IHByZXZpb3VzQ2FyZXQgKyAxO1xuICAgIH1cblxuICAgIGlmIChwcmV2aW91c1ZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGFuZ2VMZW5ndGggPSBjdXJyZW50Lmxlbmd0aCAtIHByZXZpb3VzVmFsdWUubGVuZ3RoO1xuXG4gICAgcmV0dXJuIHByZXZpb3VzQ2FyZXQgKyBjaGFuZ2VMZW5ndGg7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUNoYW5nZWRUYWlsSW5kZXgocHJldmlvdXM6IHN0cmluZywgY3VycmVudDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cnJlbnQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHByZXZpb3VzW2ldICE9PSBjdXJyZW50W2ldKSB7XG4gICAgICAgICAgICByZXR1cm4gY3VycmVudFtpXSA9PT0gYDBgID8gaSA6IGkgKyAxO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnQubGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDYXJldEdhcChcbiAgICBwcmV2aW91c1ZhbHVlOiBzdHJpbmcgPSBgYCxcbiAgICBjdXJyZW50OiBzdHJpbmcsXG4gICAgdGhvdXNhbmRTeW1ib2w6IHN0cmluZyxcbik6IG51bWJlciB7XG4gICAgY29uc3QgcGFzdGVPckN1dE9wZXJhdGlvbiA9IE1hdGguYWJzKHByZXZpb3VzVmFsdWUubGVuZ3RoIC0gY3VycmVudC5sZW5ndGgpID4gMjtcblxuICAgIGlmIChwYXN0ZU9yQ3V0T3BlcmF0aW9uKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIGNvbnN0IHdlcmVTcGFjZXMgPSBwcmV2aW91c1ZhbHVlLnNwbGl0KHRob3VzYW5kU3ltYm9sKS5sZW5ndGg7XG4gICAgY29uc3Qgbm93U3BhY2VzID0gY3VycmVudC5zcGxpdCh0aG91c2FuZFN5bWJvbCkubGVuZ3RoO1xuXG4gICAgcmV0dXJuIG5vd1NwYWNlcyAtIHdlcmVTcGFjZXM7XG59XG4iXX0=