import { __decorate, __param, __read } from "tslib";
import { DOCUMENT } from '@angular/common';
import { Directive, ElementRef, EventEmitter, Inject, Output } from '@angular/core';
import { clamp, round, TuiDestroyService, typedFromEvent } from '@taiga-ui/cdk';
import { TUI_FLOATING_PRECISION } from '@taiga-ui/kit/constants';
import { merge, Observable } from 'rxjs';
import { filter, map, repeat, startWith, switchMap, takeUntil, tap } from 'rxjs/operators';
import { TuiRangeComponent } from './range.component';
// @dynamic
var TuiRangeChangeDirective = /** @class */ (function () {
    function TuiRangeChangeDirective(documentRef, elementRef, range, destroy$) {
        var _this = this;
        this.documentRef = documentRef;
        this.elementRef = elementRef;
        this.range = range;
        /**
         * TODO replace with pointer events (when all supported browsers can handle them).
         * Dont forget to use setPointerCapture instead of listening all documentRef events
         */
        this.pointerDown$ = merge(typedFromEvent(this.elementRef.nativeElement, 'touchstart', { passive: true }).pipe(filter(function (_a) {
            var touches = _a.touches;
            return touches.length === 1;
        }), map(function (_a) {
            var touches = _a.touches;
            return touches[0];
        })), typedFromEvent(this.elementRef.nativeElement, 'mousedown', { passive: true }));
        this.pointerMove$ = merge(typedFromEvent(this.documentRef, 'touchmove').pipe(filter(function (_a) {
            var touches = _a.touches;
            return touches.length === 1;
        }), map(function (_a) {
            var touches = _a.touches;
            return touches[0];
        })), typedFromEvent(this.documentRef, 'mousemove'));
        this.pointerUp$ = merge(typedFromEvent(this.documentRef, 'touchend', { passive: true }), typedFromEvent(this.documentRef, 'mouseup', { passive: true }));
        this.activeThumbChange = new EventEmitter();
        var activeThumb;
        this.pointerDown$
            .pipe(tap(function (_a) {
            var clientX = _a.clientX, target = _a.target;
            activeThumb = _this.detectActiveThumb(clientX, target);
            _this.activeThumbChange.emit(activeThumb);
            if (_this.range.focusable) {
                elementRef.nativeElement.focus();
            }
        }), switchMap(function (event) { return _this.pointerMove$.pipe(startWith(event)); }), map(function (_a) {
            var clientX = _a.clientX;
            return clamp(_this.getFractionFromEvents(clientX), 0, 1);
        }), takeUntil(this.pointerUp$), repeat(), takeUntil(destroy$))
            .subscribe(function (fraction) {
            var value = _this.range.getValueFromFraction(_this.range.fractionGuard(fraction));
            _this.range.processValue(value, activeThumb === 'right');
        });
    }
    TuiRangeChangeDirective.prototype.getFractionFromEvents = function (clickClientX) {
        var hostRect = this.elementRef.nativeElement.getBoundingClientRect();
        var value = clickClientX - hostRect.left;
        var total = hostRect.width;
        return round(value / total, TUI_FLOATING_PRECISION);
    };
    TuiRangeChangeDirective.prototype.detectActiveThumb = function (clientX, target) {
        var _a = __read(this.range.slidersRefs, 2), leftSliderRef = _a[0], rightSliderRef = _a[1];
        switch (target) {
            case leftSliderRef.nativeElement:
                return 'left';
            case rightSliderRef.nativeElement:
                return 'right';
            default:
                return this.findNearestActiveThumb(clientX);
        }
    };
    TuiRangeChangeDirective.prototype.findNearestActiveThumb = function (clientX) {
        var fraction = this.getFractionFromEvents(clientX);
        var deltaLeft = fraction * 100 - this.range.left;
        var deltaRight = fraction * 100 - 100 + this.range.right;
        return Math.abs(deltaLeft) > Math.abs(deltaRight) ||
            deltaRight > 0 ||
            (this.range.left === 0 && this.range.right === 100)
            ? 'right'
            : 'left';
    };
    TuiRangeChangeDirective.ctorParameters = function () { return [
        { type: Document, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: ElementRef, decorators: [{ type: Inject, args: [ElementRef,] }] },
        { type: TuiRangeComponent, decorators: [{ type: Inject, args: [TuiRangeComponent,] }] },
        { type: Observable, decorators: [{ type: Inject, args: [TuiDestroyService,] }] }
    ]; };
    __decorate([
        Output()
    ], TuiRangeChangeDirective.prototype, "activeThumbChange", void 0);
    TuiRangeChangeDirective = __decorate([
        Directive({
            selector: 'tui-range',
            providers: [TuiDestroyService],
        }),
        __param(0, Inject(DOCUMENT)),
        __param(1, Inject(ElementRef)),
        __param(2, Inject(TuiRangeComponent)),
        __param(3, Inject(TuiDestroyService))
    ], TuiRangeChangeDirective);
    return TuiRangeChangeDirective;
}());
export { TuiRangeChangeDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZ2UtY2hhbmdlLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0YWlnYS11aS9raXQvY29tcG9uZW50cy9yYW5nZS8iLCJzb3VyY2VzIjpbInJhbmdlLWNoYW5nZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUMsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNsRixPQUFPLEVBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxjQUFjLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDOUUsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDL0QsT0FBTyxFQUFDLEtBQUssRUFBRSxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRXpGLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBRXBELFdBQVc7QUFLWDtJQTZCSSxpQ0FDdUMsV0FBcUIsRUFDbkIsVUFBbUMsRUFDNUIsS0FBd0IsRUFDekMsUUFBNkI7UUFKNUQsaUJBK0JDO1FBOUJzQyxnQkFBVyxHQUFYLFdBQVcsQ0FBVTtRQUNuQixlQUFVLEdBQVYsVUFBVSxDQUF5QjtRQUM1QixVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQS9CeEU7OztXQUdHO1FBQ2MsaUJBQVksR0FBRyxLQUFLLENBQ2pDLGNBQWMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUUsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQyxJQUFJ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QkFsRW1ELFFBQVEsdUJBQXZELE1BQU0sU0FBQyxRQUFRO2dCQUNpQyxVQUFVLHVCQUExRCxNQUFNLFNBQUMsVUFBVTtnQkFDaUMsaUJBQWlCLHVCQUFuRSxNQUFNLFNBQUMsaUJBQWlCO2dCQUNZLFVBQVUsdUJBQTlDLE1BQU0sU0FBQyxpQkFBaUI7O0lBTjdCO1FBREMsTUFBTSxFQUFFO3NFQUNnRDtJQTNCaEQsdUJBQXVCO1FBSm5DLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxXQUFXO1lBQ3JCLFNBQVMsRUFBRSxDQUFDLGlCQUFpQixDQUFDO1NBQ2pDLENBQUM7UUErQk8sV0FBQSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDaEIsV0FBQSxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDbEIsV0FBQSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtRQUN6QixXQUFBLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBO09BakNyQix1QkFBdUIsQ0FpR25DO0lBQUQsOEJBQUM7Q0FBQSxBQWpHRCxJQWlHQztTQWpHWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RPQ1VNRU5UfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5qZWN0LCBPdXRwdXR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtjbGFtcCwgcm91bmQsIFR1aURlc3Ryb3lTZXJ2aWNlLCB0eXBlZEZyb21FdmVudH0gZnJvbSAnQHRhaWdhLXVpL2Nkayc7XG5pbXBvcnQge1RVSV9GTE9BVElOR19QUkVDSVNJT059IGZyb20gJ0B0YWlnYS11aS9raXQvY29uc3RhbnRzJztcbmltcG9ydCB7bWVyZ2UsIE9ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmaWx0ZXIsIG1hcCwgcmVwZWF0LCBzdGFydFdpdGgsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtUdWlSYW5nZUNvbXBvbmVudH0gZnJvbSAnLi9yYW5nZS5jb21wb25lbnQnO1xuXG4vLyBAZHluYW1pY1xuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICd0dWktcmFuZ2UnLFxuICAgIHByb3ZpZGVyczogW1R1aURlc3Ryb3lTZXJ2aWNlXSxcbn0pXG5leHBvcnQgY2xhc3MgVHVpUmFuZ2VDaGFuZ2VEaXJlY3RpdmUge1xuICAgIC8qKlxuICAgICAqIFRPRE8gcmVwbGFjZSB3aXRoIHBvaW50ZXIgZXZlbnRzICh3aGVuIGFsbCBzdXBwb3J0ZWQgYnJvd3NlcnMgY2FuIGhhbmRsZSB0aGVtKS5cbiAgICAgKiBEb250IGZvcmdldCB0byB1c2Ugc2V0UG9pbnRlckNhcHR1cmUgaW5zdGVhZCBvZiBsaXN0ZW5pbmcgYWxsIGRvY3VtZW50UmVmIGV2ZW50c1xuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcG9pbnRlckRvd24kID0gbWVyZ2UoXG4gICAgICAgIHR5cGVkRnJvbUV2ZW50KHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAndG91Y2hzdGFydCcsIHtwYXNzaXZlOiB0cnVlfSkucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoe3RvdWNoZXN9KSA9PiB0b3VjaGVzLmxlbmd0aCA9PT0gMSksXG4gICAgICAgICAgICBtYXAoKHt0b3VjaGVzfSkgPT4gdG91Y2hlc1swXSksXG4gICAgICAgICksXG4gICAgICAgIHR5cGVkRnJvbUV2ZW50KHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnbW91c2Vkb3duJywge3Bhc3NpdmU6IHRydWV9KSxcbiAgICApO1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBwb2ludGVyTW92ZSQgPSBtZXJnZShcbiAgICAgICAgdHlwZWRGcm9tRXZlbnQodGhpcy5kb2N1bWVudFJlZiwgJ3RvdWNobW92ZScpLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIoKHt0b3VjaGVzfSkgPT4gdG91Y2hlcy5sZW5ndGggPT09IDEpLFxuICAgICAgICAgICAgbWFwKCh7dG91Y2hlc30pID0+IHRvdWNoZXNbMF0pLFxuICAgICAgICApLFxuICAgICAgICB0eXBlZEZyb21FdmVudCh0aGlzLmRvY3VtZW50UmVmLCAnbW91c2Vtb3ZlJyksXG4gICAgKTtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgcG9pbnRlclVwJCA9IG1lcmdlKFxuICAgICAgICB0eXBlZEZyb21FdmVudCh0aGlzLmRvY3VtZW50UmVmLCAndG91Y2hlbmQnLCB7cGFzc2l2ZTogdHJ1ZX0pLFxuICAgICAgICB0eXBlZEZyb21FdmVudCh0aGlzLmRvY3VtZW50UmVmLCAnbW91c2V1cCcsIHtwYXNzaXZlOiB0cnVlfSksXG4gICAgKTtcblxuICAgIEBPdXRwdXQoKVxuICAgIGFjdGl2ZVRodW1iQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjwnbGVmdCcgfCAncmlnaHQnPigpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnRSZWY6IERvY3VtZW50LFxuICAgICAgICBASW5qZWN0KEVsZW1lbnRSZWYpIHByaXZhdGUgcmVhZG9ubHkgZWxlbWVudFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgICAgIEBJbmplY3QoVHVpUmFuZ2VDb21wb25lbnQpIHByaXZhdGUgcmVhZG9ubHkgcmFuZ2U6IFR1aVJhbmdlQ29tcG9uZW50LFxuICAgICAgICBASW5qZWN0KFR1aURlc3Ryb3lTZXJ2aWNlKSBkZXN0cm95JDogT2JzZXJ2YWJsZTx1bmtub3duPixcbiAgICApIHtcbiAgICAgICAgbGV0IGFjdGl2ZVRodW1iOiAnbGVmdCcgfCAncmlnaHQnO1xuXG4gICAgICAgIHRoaXMucG9pbnRlckRvd24kXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICB0YXAoKHtjbGllbnRYLCB0YXJnZXR9KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVRodW1iID0gdGhpcy5kZXRlY3RBY3RpdmVUaHVtYihjbGllbnRYLCB0YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZVRodW1iQ2hhbmdlLmVtaXQoYWN0aXZlVGh1bWIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJhbmdlLmZvY3VzYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoZXZlbnQgPT4gdGhpcy5wb2ludGVyTW92ZSQucGlwZShzdGFydFdpdGgoZXZlbnQpKSksXG4gICAgICAgICAgICAgICAgbWFwKCh7Y2xpZW50WH0pID0+IGNsYW1wKHRoaXMuZ2V0RnJhY3Rpb25Gcm9tRXZlbnRzKGNsaWVudFgpLCAwLCAxKSksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMucG9pbnRlclVwJCksXG4gICAgICAgICAgICAgICAgcmVwZWF0KCksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKGRlc3Ryb3kkKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoZnJhY3Rpb24gPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5yYW5nZS5nZXRWYWx1ZUZyb21GcmFjdGlvbihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yYW5nZS5mcmFjdGlvbkd1YXJkKGZyYWN0aW9uKSxcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5yYW5nZS5wcm9jZXNzVmFsdWUodmFsdWUsIGFjdGl2ZVRodW1iID09PSAncmlnaHQnKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RnJhY3Rpb25Gcm9tRXZlbnRzKGNsaWNrQ2xpZW50WDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgaG9zdFJlY3QgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBjbGlja0NsaWVudFggLSBob3N0UmVjdC5sZWZ0O1xuICAgICAgICBjb25zdCB0b3RhbCA9IGhvc3RSZWN0LndpZHRoO1xuXG4gICAgICAgIHJldHVybiByb3VuZCh2YWx1ZSAvIHRvdGFsLCBUVUlfRkxPQVRJTkdfUFJFQ0lTSU9OKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRldGVjdEFjdGl2ZVRodW1iKFxuICAgICAgICBjbGllbnRYOiBudW1iZXIsXG4gICAgICAgIHRhcmdldDogRXZlbnRUYXJnZXQgfCBudWxsLFxuICAgICk6ICdsZWZ0JyB8ICdyaWdodCcge1xuICAgICAgICBjb25zdCBbbGVmdFNsaWRlclJlZiwgcmlnaHRTbGlkZXJSZWZdID0gdGhpcy5yYW5nZS5zbGlkZXJzUmVmcztcblxuICAgICAgICBzd2l0Y2ggKHRhcmdldCkge1xuICAgICAgICAgICAgY2FzZSBsZWZ0U2xpZGVyUmVmLm5hdGl2ZUVsZW1lbnQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuICdsZWZ0JztcbiAgICAgICAgICAgIGNhc2UgcmlnaHRTbGlkZXJSZWYubmF0aXZlRWxlbWVudDpcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3JpZ2h0JztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZmluZE5lYXJlc3RBY3RpdmVUaHVtYihjbGllbnRYKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZmluZE5lYXJlc3RBY3RpdmVUaHVtYihjbGllbnRYOiBudW1iZXIpOiAnbGVmdCcgfCAncmlnaHQnIHtcbiAgICAgICAgY29uc3QgZnJhY3Rpb24gPSB0aGlzLmdldEZyYWN0aW9uRnJvbUV2ZW50cyhjbGllbnRYKTtcbiAgICAgICAgY29uc3QgZGVsdGFMZWZ0ID0gZnJhY3Rpb24gKiAxMDAgLSB0aGlzLnJhbmdlLmxlZnQ7XG4gICAgICAgIGNvbnN0IGRlbHRhUmlnaHQgPSBmcmFjdGlvbiAqIDEwMCAtIDEwMCArIHRoaXMucmFuZ2UucmlnaHQ7XG5cbiAgICAgICAgcmV0dXJuIE1hdGguYWJzKGRlbHRhTGVmdCkgPiBNYXRoLmFicyhkZWx0YVJpZ2h0KSB8fFxuICAgICAgICAgICAgZGVsdGFSaWdodCA+IDAgfHxcbiAgICAgICAgICAgICh0aGlzLnJhbmdlLmxlZnQgPT09IDAgJiYgdGhpcy5yYW5nZS5yaWdodCA9PT0gMTAwKVxuICAgICAgICAgICAgPyAncmlnaHQnXG4gICAgICAgICAgICA6ICdsZWZ0JztcbiAgICB9XG59XG4iXX0=