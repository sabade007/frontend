import { __decorate, __param } from "tslib";
import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ContentChildren, ElementRef, EventEmitter, forwardRef, HostBinding, HostListener, Inject, Input, Output, QueryList, } from '@angular/core';
import { EMPTY_QUERY, tuiAssertIsHTMLElement, tuiDefaultProp, TuiDestroyService, tuiGetOriginalArrayFromQueryList, tuiItemsQueryListObservable, tuiMoveFocus, tuiPure, TuiResizeService, TuiScrollService, } from '@taiga-ui/cdk';
import { TUI_ANIMATIONS_DURATION } from '@taiga-ui/core';
import { Observable } from 'rxjs';
import { delay } from 'rxjs/operators';
import { TuiStepComponent } from './step/step.component';
var TuiStepperComponent = /** @class */ (function () {
    function TuiStepperComponent(changeDetectorRef, elementRef, scrollService, resize$, duration) {
        var _this = this;
        this.changeDetectorRef = changeDetectorRef;
        this.elementRef = elementRef;
        this.scrollService = scrollService;
        this.duration = duration;
        this.steps = EMPTY_QUERY;
        this.orientation = 'horizontal';
        this.activeItemIndexChange = new EventEmitter();
        this.activeItemIndex = 0;
        resize$.subscribe(function () { return _this.scrollIntoView(_this.activeItemIndex); });
    }
    Object.defineProperty(TuiStepperComponent.prototype, "activeIndex", {
        set: function (index) {
            this.activeItemIndex = index;
            this.scrollIntoView(index);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiStepperComponent.prototype, "changes$", {
        get: function () {
            // Delay is required to trigger change detection after steps are rendered,
            // so they can update their "active" status
            return tuiItemsQueryListObservable(this.steps).pipe(delay(0));
        },
        enumerable: true,
        configurable: true
    });
    TuiStepperComponent.prototype.onHorizontal = function (event, step) {
        if (this.orientation !== 'horizontal' || !event.target) {
            return;
        }
        event.preventDefault();
        this.moveFocus(event.target, step);
    };
    TuiStepperComponent.prototype.onVertical = function (event, step) {
        if (this.orientation !== 'vertical' || !event.target) {
            return;
        }
        event.preventDefault();
        this.moveFocus(event.target, step);
    };
    TuiStepperComponent.prototype.indexOf = function (step) {
        return tuiGetOriginalArrayFromQueryList(this.steps).findIndex(function (_a) {
            var nativeElement = _a.nativeElement;
            return nativeElement === step;
        });
    };
    TuiStepperComponent.prototype.isActive = function (index) {
        return index === this.activeItemIndex;
    };
    TuiStepperComponent.prototype.activate = function (index) {
        if (this.activeItemIndex === index) {
            return;
        }
        this.activeItemIndex = index;
        this.activeItemIndexChange.emit(index);
        this.changeDetectorRef.markForCheck();
        this.scrollIntoView(index);
    };
    TuiStepperComponent.prototype.getNativeElements = function (queryList) {
        return queryList.map(function (_a) {
            var nativeElement = _a.nativeElement;
            return nativeElement;
        });
    };
    TuiStepperComponent.prototype.moveFocus = function (current, step) {
        tuiAssertIsHTMLElement(current);
        var stepElements = this.getNativeElements(this.steps);
        tuiMoveFocus(stepElements.indexOf(current), stepElements, step);
    };
    TuiStepperComponent.prototype.scrollIntoView = function (index) {
        var step = this.getNativeElements(this.steps)[index];
        if (!step) {
            return;
        }
        var nativeElement = this.elementRef.nativeElement;
        var clientHeight = nativeElement.clientHeight, clientWidth = nativeElement.clientWidth, offsetTop = nativeElement.offsetTop, offsetLeft = nativeElement.offsetLeft;
        var offsetHeight = step.offsetHeight, offsetWidth = step.offsetWidth, stepOffsetTop = step.offsetTop, stepOffsetLeft = step.offsetLeft;
        var top = stepOffsetTop - offsetTop - clientHeight / 2 + offsetHeight / 2;
        var left = stepOffsetLeft - offsetLeft - clientWidth / 2 + offsetWidth / 2;
        this.scrollService
            .scroll$(nativeElement, Math.max(0, top), Math.max(0, left), this.duration / 3)
            .subscribe();
    };
    TuiStepperComponent.ctorParameters = function () { return [
        { type: ChangeDetectorRef, decorators: [{ type: Inject, args: [ChangeDetectorRef,] }] },
        { type: ElementRef, decorators: [{ type: Inject, args: [ElementRef,] }] },
        { type: TuiScrollService, decorators: [{ type: Inject, args: [TuiScrollService,] }] },
        { type: Observable, decorators: [{ type: Inject, args: [TuiResizeService,] }] },
        { type: Number, decorators: [{ type: Inject, args: [TUI_ANIMATIONS_DURATION,] }] }
    ]; };
    __decorate([
        ContentChildren(forwardRef(function () { return TuiStepComponent; }), { read: ElementRef })
    ], TuiStepperComponent.prototype, "steps", void 0);
    __decorate([
        Input(),
        HostBinding('attr.data-orientation'),
        tuiDefaultProp()
    ], TuiStepperComponent.prototype, "orientation", void 0);
    __decorate([
        Input('activeItemIndex')
    ], TuiStepperComponent.prototype, "activeIndex", null);
    __decorate([
        Output()
    ], TuiStepperComponent.prototype, "activeItemIndexChange", void 0);
    __decorate([
        tuiPure
    ], TuiStepperComponent.prototype, "changes$", null);
    __decorate([
        HostListener('keydown.arrowRight', ['$event', '1']),
        HostListener('keydown.arrowLeft', ['$event', '-1'])
    ], TuiStepperComponent.prototype, "onHorizontal", null);
    __decorate([
        HostListener('keydown.arrowDown', ['$event', '1']),
        HostListener('keydown.arrowUp', ['$event', '-1'])
    ], TuiStepperComponent.prototype, "onVertical", null);
    __decorate([
        tuiPure
    ], TuiStepperComponent.prototype, "getNativeElements", null);
    TuiStepperComponent = __decorate([
        Component({
            selector: 'tui-stepper, nav[tuiStepper]',
            template: "<ng-container *ngIf=\"changes$ | async\"></ng-container>\n<ng-content></ng-content>\n",
            changeDetection: ChangeDetectionStrategy.OnPush,
            providers: [TuiResizeService, TuiDestroyService],
            styles: [":host{scrollbar-width:none;-ms-overflow-style:none;display:flex;overflow:auto;counter-reset:steps;scroll-behavior:smooth}:host::-webkit-scrollbar,:host::-webkit-scrollbar-thumb{background:0 0;width:0;height:0}:host[data-orientation=vertical]{flex-direction:column}"]
        }),
        __param(0, Inject(ChangeDetectorRef)),
        __param(1, Inject(ElementRef)),
        __param(2, Inject(TuiScrollService)),
        __param(3, Inject(TuiResizeService)),
        __param(4, Inject(TUI_ANIMATIONS_DURATION))
    ], TuiStepperComponent);
    return TuiStepperComponent;
}());
export { TuiStepperComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkva2l0L2NvbXBvbmVudHMvc3RlcHBlci8iLCJzb3VyY2VzIjpbInN0ZXBwZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0gsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsZUFBZSxFQUNmLFVBQVUsRUFDVixZQUFZLEVBQ1osVUFBVSxFQUNWLFdBQVcsRUFDWCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEVBQ04sU0FBUyxHQUNaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFDSCxXQUFXLEVBQ1gsc0JBQXNCLEVBQ3RCLGNBQWMsRUFDZCxpQkFBaUIsRUFDakIsZ0NBQWdDLEVBQ2hDLDJCQUEyQixFQUMzQixZQUFZLEVBQ1osT0FBTyxFQUNQLGdCQUFnQixFQUNoQixnQkFBZ0IsR0FDbkIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFDLHVCQUF1QixFQUFrQixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDaEMsT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBU3ZEO0lBb0JJLDZCQUNnRCxpQkFBb0MsRUFDM0MsVUFBbUMsRUFDN0IsYUFBK0IsRUFDaEQsT0FBeUIsRUFDRCxRQUFnQjtRQUx0RSxpQkFRQztRQVArQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQzNDLGVBQVUsR0FBVixVQUFVLENBQXlCO1FBQzdCLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQUV4QixhQUFRLEdBQVIsUUFBUSxDQUFRO1FBdkJyRCxVQUFLLEdBQXVDLFdBQVcsQ0FBQztRQUt6RSxnQkFBVyxHQUFvQixZQUFZLENBQUM7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ZURldGVjdG9yUmVmLFxuICAgIENvbXBvbmVudCxcbiAgICBDb250ZW50Q2hpbGRyZW4sXG4gICAgRWxlbWVudFJlZixcbiAgICBFdmVudEVtaXR0ZXIsXG4gICAgZm9yd2FyZFJlZixcbiAgICBIb3N0QmluZGluZyxcbiAgICBIb3N0TGlzdGVuZXIsXG4gICAgSW5qZWN0LFxuICAgIElucHV0LFxuICAgIE91dHB1dCxcbiAgICBRdWVyeUxpc3QsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBFTVBUWV9RVUVSWSxcbiAgICB0dWlBc3NlcnRJc0hUTUxFbGVtZW50LFxuICAgIHR1aURlZmF1bHRQcm9wLFxuICAgIFR1aURlc3Ryb3lTZXJ2aWNlLFxuICAgIHR1aUdldE9yaWdpbmFsQXJyYXlGcm9tUXVlcnlMaXN0LFxuICAgIHR1aUl0ZW1zUXVlcnlMaXN0T2JzZXJ2YWJsZSxcbiAgICB0dWlNb3ZlRm9jdXMsXG4gICAgdHVpUHVyZSxcbiAgICBUdWlSZXNpemVTZXJ2aWNlLFxuICAgIFR1aVNjcm9sbFNlcnZpY2UsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsnO1xuaW1wb3J0IHtUVUlfQU5JTUFUSU9OU19EVVJBVElPTiwgVHVpT3JpZW50YXRpb25UfSBmcm9tICdAdGFpZ2EtdWkvY29yZSc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtkZWxheX0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1R1aVN0ZXBDb21wb25lbnR9IGZyb20gJy4vc3RlcC9zdGVwLmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAndHVpLXN0ZXBwZXIsIG5hdlt0dWlTdGVwcGVyXScsXG4gICAgdGVtcGxhdGVVcmw6ICcuL3N0ZXBwZXIudGVtcGxhdGUuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vc3RlcHBlci5zdHlsZS5sZXNzJ10sXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gICAgcHJvdmlkZXJzOiBbVHVpUmVzaXplU2VydmljZSwgVHVpRGVzdHJveVNlcnZpY2VdLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlTdGVwcGVyQ29tcG9uZW50IHtcbiAgICBAQ29udGVudENoaWxkcmVuKGZvcndhcmRSZWYoKCkgPT4gVHVpU3RlcENvbXBvbmVudCksIHtyZWFkOiBFbGVtZW50UmVmfSlcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0ZXBzOiBRdWVyeUxpc3Q8RWxlbWVudFJlZjxIVE1MRWxlbWVudD4+ID0gRU1QVFlfUVVFUlk7XG5cbiAgICBASW5wdXQoKVxuICAgIEBIb3N0QmluZGluZygnYXR0ci5kYXRhLW9yaWVudGF0aW9uJylcbiAgICBAdHVpRGVmYXVsdFByb3AoKVxuICAgIG9yaWVudGF0aW9uOiBUdWlPcmllbnRhdGlvblQgPSAnaG9yaXpvbnRhbCc7XG5cbiAgICBASW5wdXQoJ2FjdGl2ZUl0ZW1JbmRleCcpXG4gICAgc2V0IGFjdGl2ZUluZGV4KGluZGV4OiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVJdGVtSW5kZXggPSBpbmRleDtcbiAgICAgICAgdGhpcy5zY3JvbGxJbnRvVmlldyhpbmRleCk7XG4gICAgfVxuXG4gICAgQE91dHB1dCgpXG4gICAgcmVhZG9ubHkgYWN0aXZlSXRlbUluZGV4Q2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG5cbiAgICBhY3RpdmVJdGVtSW5kZXggPSAwO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIEBJbmplY3QoQ2hhbmdlRGV0ZWN0b3JSZWYpIHByaXZhdGUgcmVhZG9ubHkgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgICAgICBASW5qZWN0KEVsZW1lbnRSZWYpIHByaXZhdGUgcmVhZG9ubHkgZWxlbWVudFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXG4gICAgICAgIEBJbmplY3QoVHVpU2Nyb2xsU2VydmljZSkgcHJpdmF0ZSByZWFkb25seSBzY3JvbGxTZXJ2aWNlOiBUdWlTY3JvbGxTZXJ2aWNlLFxuICAgICAgICBASW5qZWN0KFR1aVJlc2l6ZVNlcnZpY2UpIHJlc2l6ZSQ6IE9ic2VydmFibGU8dm9pZD4sXG4gICAgICAgIEBJbmplY3QoVFVJX0FOSU1BVElPTlNfRFVSQVRJT04pIHByaXZhdGUgcmVhZG9ubHkgZHVyYXRpb246IG51bWJlcixcbiAgICApIHtcbiAgICAgICAgcmVzaXplJC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5zY3JvbGxJbnRvVmlldyh0aGlzLmFjdGl2ZUl0ZW1JbmRleCkpO1xuICAgIH1cblxuICAgIEB0dWlQdXJlXG4gICAgZ2V0IGNoYW5nZXMkKCk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgICAgICAvLyBEZWxheSBpcyByZXF1aXJlZCB0byB0cmlnZ2VyIGNoYW5nZSBkZXRlY3Rpb24gYWZ0ZXIgc3RlcHMgYXJlIHJlbmRlcmVkLFxuICAgICAgICAvLyBzbyB0aGV5IGNhbiB1cGRhdGUgdGhlaXIgXCJhY3RpdmVcIiBzdGF0dXNcbiAgICAgICAgcmV0dXJuIHR1aUl0ZW1zUXVlcnlMaXN0T2JzZXJ2YWJsZSh0aGlzLnN0ZXBzKS5waXBlKGRlbGF5KDApKTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdrZXlkb3duLmFycm93UmlnaHQnLCBbJyRldmVudCcsICcxJ10pXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd0xlZnQnLCBbJyRldmVudCcsICctMSddKVxuICAgIG9uSG9yaXpvbnRhbChldmVudDogRXZlbnQsIHN0ZXA6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5vcmllbnRhdGlvbiAhPT0gJ2hvcml6b250YWwnIHx8ICFldmVudC50YXJnZXQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoaXMubW92ZUZvY3VzKGV2ZW50LnRhcmdldCwgc3RlcCk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd0Rvd24nLCBbJyRldmVudCcsICcxJ10pXG4gICAgQEhvc3RMaXN0ZW5lcigna2V5ZG93bi5hcnJvd1VwJywgWyckZXZlbnQnLCAnLTEnXSlcbiAgICBvblZlcnRpY2FsKGV2ZW50OiBFdmVudCwgc3RlcDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLm9yaWVudGF0aW9uICE9PSAndmVydGljYWwnIHx8ICFldmVudC50YXJnZXQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoaXMubW92ZUZvY3VzKGV2ZW50LnRhcmdldCwgc3RlcCk7XG4gICAgfVxuXG4gICAgaW5kZXhPZihzdGVwOiBIVE1MRWxlbWVudCk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiB0dWlHZXRPcmlnaW5hbEFycmF5RnJvbVF1ZXJ5TGlzdCh0aGlzLnN0ZXBzKS5maW5kSW5kZXgoXG4gICAgICAgICAgICAoe25hdGl2ZUVsZW1lbnR9KSA9PiBuYXRpdmVFbGVtZW50ID09PSBzdGVwLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlzQWN0aXZlKGluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGluZGV4ID09PSB0aGlzLmFjdGl2ZUl0ZW1JbmRleDtcbiAgICB9XG5cbiAgICBhY3RpdmF0ZShpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZUl0ZW1JbmRleCA9PT0gaW5kZXgpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuYWN0aXZlSXRlbUluZGV4ID0gaW5kZXg7XG4gICAgICAgIHRoaXMuYWN0aXZlSXRlbUluZGV4Q2hhbmdlLmVtaXQoaW5kZXgpO1xuICAgICAgICB0aGlzLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgICAgICB0aGlzLnNjcm9sbEludG9WaWV3KGluZGV4KTtcbiAgICB9XG5cbiAgICBAdHVpUHVyZVxuICAgIHByaXZhdGUgZ2V0TmF0aXZlRWxlbWVudHMoXG4gICAgICAgIHF1ZXJ5TGlzdDogUXVlcnlMaXN0PEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+PixcbiAgICApOiBIVE1MRWxlbWVudFtdIHtcbiAgICAgICAgcmV0dXJuIHF1ZXJ5TGlzdC5tYXAoKHtuYXRpdmVFbGVtZW50fSkgPT4gbmF0aXZlRWxlbWVudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBtb3ZlRm9jdXMoY3VycmVudDogRXZlbnRUYXJnZXQsIHN0ZXA6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0dWlBc3NlcnRJc0hUTUxFbGVtZW50KGN1cnJlbnQpO1xuXG4gICAgICAgIGNvbnN0IHN0ZXBFbGVtZW50cyA9IHRoaXMuZ2V0TmF0aXZlRWxlbWVudHModGhpcy5zdGVwcyk7XG5cbiAgICAgICAgdHVpTW92ZUZvY3VzKHN0ZXBFbGVtZW50cy5pbmRleE9mKGN1cnJlbnQpLCBzdGVwRWxlbWVudHMsIHN0ZXApO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2Nyb2xsSW50b1ZpZXcoaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCBzdGVwID0gdGhpcy5nZXROYXRpdmVFbGVtZW50cyh0aGlzLnN0ZXBzKVtpbmRleF07XG5cbiAgICAgICAgaWYgKCFzdGVwKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7bmF0aXZlRWxlbWVudH0gPSB0aGlzLmVsZW1lbnRSZWY7XG4gICAgICAgIGNvbnN0IHtjbGllbnRIZWlnaHQsIGNsaWVudFdpZHRoLCBvZmZzZXRUb3AsIG9mZnNldExlZnR9ID0gbmF0aXZlRWxlbWVudDtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgb2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgb2Zmc2V0V2lkdGgsXG4gICAgICAgICAgICBvZmZzZXRUb3A6IHN0ZXBPZmZzZXRUb3AsXG4gICAgICAgICAgICBvZmZzZXRMZWZ0OiBzdGVwT2Zmc2V0TGVmdCxcbiAgICAgICAgfSA9IHN0ZXA7XG4gICAgICAgIGNvbnN0IHRvcCA9IHN0ZXBPZmZzZXRUb3AgLSBvZmZzZXRUb3AgLSBjbGllbnRIZWlnaHQgLyAyICsgb2Zmc2V0SGVpZ2h0IC8gMjtcbiAgICAgICAgY29uc3QgbGVmdCA9IHN0ZXBPZmZzZXRMZWZ0IC0gb2Zmc2V0TGVmdCAtIGNsaWVudFdpZHRoIC8gMiArIG9mZnNldFdpZHRoIC8gMjtcblxuICAgICAgICB0aGlzLnNjcm9sbFNlcnZpY2VcbiAgICAgICAgICAgIC5zY3JvbGwkKFxuICAgICAgICAgICAgICAgIG5hdGl2ZUVsZW1lbnQsXG4gICAgICAgICAgICAgICAgTWF0aC5tYXgoMCwgdG9wKSxcbiAgICAgICAgICAgICAgICBNYXRoLm1heCgwLCBsZWZ0KSxcbiAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uIC8gMyxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKTtcbiAgICB9XG59XG4iXX0=