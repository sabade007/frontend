import { __decorate, __extends, __param } from "tslib";
import { DOCUMENT } from '@angular/common';
import { ComponentFactoryResolver, Directive, ElementRef, forwardRef, HostListener, Inject, Injector, Input, } from '@angular/core';
import { EMPTY_CLIENT_RECT, getClosestFocusable, getNativeFocused, setNativeFocused, TuiActiveZoneDirective, tuiDefaultProp, TuiDestroyService, tuiPointToClientRect, TuiPortalService, } from '@taiga-ui/cdk';
import { AbstractTuiDropdown, TUI_DROPDOWN_DIRECTIVE } from '@taiga-ui/core';
import { EMPTY, Observable } from 'rxjs';
import { filter, takeUntil } from 'rxjs/operators';
// @dynamic
var TuiDropdownContextDirective = /** @class */ (function (_super) {
    __extends(TuiDropdownContextDirective, _super);
    function TuiDropdownContextDirective(elementRef, documentRef, destroy$, componentFactoryResolver, injector, portalService, activeZone) {
        var _this = _super.call(this, componentFactoryResolver, injector, portalService, elementRef, activeZone) || this;
        _this.elementRef = elementRef;
        _this.documentRef = documentRef;
        _this.activeZone = activeZone;
        _this.lastClickedClientRect = EMPTY_CLIENT_RECT;
        _this.content = '';
        _this.refresh$ = EMPTY;
        _this.context = { close: function () { return _this.closeDropdownBox(); } };
        activeZone.tuiActiveZoneChange
            .pipe(filter(function (isActive) { return !isActive; }), takeUntil(destroy$))
            .subscribe(function () { return _this.closeDropdownBox(); });
        return _this;
    }
    TuiDropdownContextDirective_1 = TuiDropdownContextDirective;
    Object.defineProperty(TuiDropdownContextDirective.prototype, "clientRect", {
        get: function () {
            return this.lastClickedClientRect;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiDropdownContextDirective.prototype, "fixed", {
        get: function () {
            return true;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiDropdownContextDirective.prototype, "dropdownContent", {
        get: function () {
            var _a, _b;
            return ((_b = (_a = this.dropdownBoxRef) === null || _a === void 0 ? void 0 : _a.instance.contentElementRef) === null || _b === void 0 ? void 0 : _b.nativeElement) || null;
        },
        enumerable: true,
        configurable: true
    });
    TuiDropdownContextDirective.prototype.onHostClick = function () {
        this.closeDropdownBox();
    };
    TuiDropdownContextDirective.prototype.onContextMenu = function (x, y) {
        this.closeDropdownBox();
        this.openDropdown(x, y);
    };
    TuiDropdownContextDirective.prototype.onAnotherContextOpen = function (target) {
        var isAnotherContextOpened = !this.elementRef.nativeElement.contains(target);
        if (isAnotherContextOpened) {
            this.closeDropdownBox();
        }
    };
    TuiDropdownContextDirective.prototype.onArrow = function (event, down) {
        var activeElement = getNativeFocused(this.documentRef);
        var focusInside = activeElement && this.activeZone.contains(activeElement);
        if (!this.dropdownContent || focusInside) {
            return;
        }
        event.preventDefault();
        var nextEl = this.dropdownContent.nextElementSibling;
        var initial = down || !this.checkIsFocusableElement(nextEl) ? this.dropdownContent : nextEl;
        var focusable = getClosestFocusable(initial, !down, this.dropdownContent);
        if (focusable === null) {
            return;
        }
        setNativeFocused(focusable);
    };
    TuiDropdownContextDirective.prototype.onKeyDownEsc = function (event) {
        if (!this.dropdownContent) {
            return;
        }
        event.stopPropagation();
        this.closeDropdownBox();
    };
    TuiDropdownContextDirective.prototype.openDropdown = function (x, y) {
        this.lastClickedClientRect = tuiPointToClientRect(x, y);
        this.openDropdownBox();
    };
    TuiDropdownContextDirective.prototype.checkIsFocusableElement = function (element) {
        return !!element && 'focus' in element && 'blur' in element;
    };
    var TuiDropdownContextDirective_1;
    TuiDropdownContextDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Document, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
        { type: Observable, decorators: [{ type: Inject, args: [TuiDestroyService,] }] },
        { type: ComponentFactoryResolver, decorators: [{ type: Inject, args: [ComponentFactoryResolver,] }] },
        { type: Injector, decorators: [{ type: Inject, args: [Injector,] }] },
        { type: TuiPortalService, decorators: [{ type: Inject, args: [TuiPortalService,] }] },
        { type: TuiActiveZoneDirective }
    ]; };
    __decorate([
        Input('tuiDropdownContext'),
        tuiDefaultProp()
    ], TuiDropdownContextDirective.prototype, "content", void 0);
    __decorate([
        HostListener('click')
    ], TuiDropdownContextDirective.prototype, "onHostClick", null);
    __decorate([
        HostListener('contextmenu.prevent', ['$event.clientX', '$event.clientY'])
    ], TuiDropdownContextDirective.prototype, "onContextMenu", null);
    __decorate([
        HostListener('document:contextmenu', ['$event.target'])
    ], TuiDropdownContextDirective.prototype, "onAnotherContextOpen", null);
    __decorate([
        HostListener('document:keydown.arrowDown', ['$event', 'true']),
        HostListener('document:keydown.arrowUp', ['$event', 'false'])
    ], TuiDropdownContextDirective.prototype, "onArrow", null);
    __decorate([
        HostListener('document:keydown.esc', ['$event'])
    ], TuiDropdownContextDirective.prototype, "onKeyDownEsc", null);
    TuiDropdownContextDirective = TuiDropdownContextDirective_1 = __decorate([
        Directive({
            selector: '[tuiDropdownContext]',
            providers: [
                TuiDestroyService,
                TuiActiveZoneDirective,
                {
                    provide: TUI_DROPDOWN_DIRECTIVE,
                    useExisting: forwardRef(function () { return TuiDropdownContextDirective_1; }),
                },
            ],
        }),
        __param(1, Inject(DOCUMENT)),
        __param(2, Inject(TuiDestroyService)),
        __param(3, Inject(ComponentFactoryResolver)),
        __param(4, Inject(Injector)),
        __param(5, Inject(TuiPortalService))
    ], TuiDropdownContextDirective);
    return TuiDropdownContextDirective;
}(AbstractTuiDropdown));
export { TuiDropdownContextDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24tY29udGV4dC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkva2l0L2RpcmVjdGl2ZXMvZHJvcGRvd24tY29udGV4dC8iLCJzb3VyY2VzIjpbImRyb3Bkb3duLWNvbnRleHQuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUNILHdCQUF3QixFQUN4QixTQUFTLEVBQ1QsVUFBVSxFQUNWLFVBQVUsRUFDVixZQUFZLEVBQ1osTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLEdBQ1IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUNILGlCQUFpQixFQUNqQixtQkFBbUIsRUFDbkIsZ0JBQWdCLEVBQ2hCLGdCQUFnQixFQUNoQixzQkFBc0IsRUFDdEIsY0FBYyxFQUNkLGlCQUFpQixFQUNqQixvQkFBb0IsRUFDcEIsZ0JBQWdCLEdBQ25CLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxtQkFBbUIsRUFBRSxzQkFBc0IsRUFBYyxNQUFNLGdCQUFnQixDQUFDO0FBRXhGLE9BQU8sRUFBQyxLQUFLLEVBQUUsVUFBVSxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBQyxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQsV0FBVztBQVlYO0lBQ1ksK0NBQW1CO0lBYTNCLHFDQUN1QixVQUFzQixFQUNOLFdBQXFCLEVBQzdCLFFBQTZCLEVBRXhELHdCQUFrRCxFQUNoQyxRQUFrQixFQUNWLGFBQStCLEVBQ2hELFVBQWtDO1FBUi9DLFlBVUksa0JBQU0sd0JBQXdCLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLFNBUW5GO1FBakJzQixnQkFBVSxHQUFWLFVBQVUsQ0FBWTtRQUNOLGlCQUFXLEdBQVgsV0FBVyxDQUFVO1FBTS9DLGdC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LFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxzQkFBc0I7WUFDaEMsU0FBUyxFQUFFO2dCQUNQLGlCQUFpQjtnQkFDakIsc0JBQXNCO2dCQUN0QjtvQkFDSSxPQUFPLEVBQUUsc0JBQXNCO29CQUMvQixXQUFXLEVBQUUsVUFBVSxDQUFDLGNBQU0sT0FBQSw2QkFBMkIsRUFBM0IsQ0FBMkIsQ0FBQztpQkFDN0Q7YUFDSjtTQUNKLENBQUM7UUFpQk8sV0FBQSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDaEIsV0FBQSxNQUFNLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtRQUN6QixXQUFBLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO1FBRWhDLFdBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ2hCLFdBQUEsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUE7T0FyQnBCLDJCQUEyQixDQTRHdkM7SUFBRCxrQ0FBQztDQUFBLEFBNUdELENBQ1ksbUJBQW1CLEdBMkc5QjtTQTVHWSwyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RPQ1VNRU5UfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgRGlyZWN0aXZlLFxuICAgIEVsZW1lbnRSZWYsXG4gICAgZm9yd2FyZFJlZixcbiAgICBIb3N0TGlzdGVuZXIsXG4gICAgSW5qZWN0LFxuICAgIEluamVjdG9yLFxuICAgIElucHV0LFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgRU1QVFlfQ0xJRU5UX1JFQ1QsXG4gICAgZ2V0Q2xvc2VzdEZvY3VzYWJsZSxcbiAgICBnZXROYXRpdmVGb2N1c2VkLFxuICAgIHNldE5hdGl2ZUZvY3VzZWQsXG4gICAgVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSxcbiAgICB0dWlEZWZhdWx0UHJvcCxcbiAgICBUdWlEZXN0cm95U2VydmljZSxcbiAgICB0dWlQb2ludFRvQ2xpZW50UmVjdCxcbiAgICBUdWlQb3J0YWxTZXJ2aWNlLFxufSBmcm9tICdAdGFpZ2EtdWkvY2RrJztcbmltcG9ydCB7QWJzdHJhY3RUdWlEcm9wZG93biwgVFVJX0RST1BET1dOX0RJUkVDVElWRSwgVHVpRHJvcGRvd259IGZyb20gJ0B0YWlnYS11aS9jb3JlJztcbmltcG9ydCB7UG9seW1vcnBoZXVzQ29udGVudH0gZnJvbSAnQHRpbmtvZmYvbmctcG9seW1vcnBoZXVzJztcbmltcG9ydCB7RU1QVFksIE9ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtmaWx0ZXIsIHRha2VVbnRpbH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vLyBAZHluYW1pY1xuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICdbdHVpRHJvcGRvd25Db250ZXh0XScsXG4gICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIFR1aURlc3Ryb3lTZXJ2aWNlLFxuICAgICAgICBUdWlBY3RpdmVab25lRGlyZWN0aXZlLFxuICAgICAgICB7XG4gICAgICAgICAgICBwcm92aWRlOiBUVUlfRFJPUERPV05fRElSRUNUSVZFLFxuICAgICAgICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gVHVpRHJvcGRvd25Db250ZXh0RGlyZWN0aXZlKSxcbiAgICAgICAgfSxcbiAgICBdLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlEcm9wZG93bkNvbnRleHREaXJlY3RpdmVcbiAgICBleHRlbmRzIEFic3RyYWN0VHVpRHJvcGRvd25cbiAgICBpbXBsZW1lbnRzIFR1aURyb3Bkb3duXG57XG4gICAgcHJpdmF0ZSBsYXN0Q2xpY2tlZENsaWVudFJlY3QgPSBFTVBUWV9DTElFTlRfUkVDVDtcblxuICAgIEBJbnB1dCgndHVpRHJvcGRvd25Db250ZXh0JylcbiAgICBAdHVpRGVmYXVsdFByb3AoKVxuICAgIGNvbnRlbnQ6IFBvbHltb3JwaGV1c0NvbnRlbnQgPSAnJztcblxuICAgIHJlYWRvbmx5IHJlZnJlc2gkID0gRU1QVFk7XG5cbiAgICByZWFkb25seSBjb250ZXh0ID0ge2Nsb3NlOiAoKSA9PiB0aGlzLmNsb3NlRHJvcGRvd25Cb3goKX07XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIHJlYWRvbmx5IGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgcmVhZG9ubHkgZG9jdW1lbnRSZWY6IERvY3VtZW50LFxuICAgICAgICBASW5qZWN0KFR1aURlc3Ryb3lTZXJ2aWNlKSBkZXN0cm95JDogT2JzZXJ2YWJsZTx1bmtub3duPixcbiAgICAgICAgQEluamVjdChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpXG4gICAgICAgIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgICAgICBASW5qZWN0KEluamVjdG9yKSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgICAgIEBJbmplY3QoVHVpUG9ydGFsU2VydmljZSkgcG9ydGFsU2VydmljZTogVHVpUG9ydGFsU2VydmljZSxcbiAgICAgICAgcmVhZG9ubHkgYWN0aXZlWm9uZTogVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSxcbiAgICApIHtcbiAgICAgICAgc3VwZXIoY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBpbmplY3RvciwgcG9ydGFsU2VydmljZSwgZWxlbWVudFJlZiwgYWN0aXZlWm9uZSk7XG5cbiAgICAgICAgYWN0aXZlWm9uZS50dWlBY3RpdmVab25lQ2hhbmdlXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBmaWx0ZXIoaXNBY3RpdmUgPT4gIWlzQWN0aXZlKSxcbiAgICAgICAgICAgICAgICB0YWtlVW50aWwoZGVzdHJveSQpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLmNsb3NlRHJvcGRvd25Cb3goKSk7XG4gICAgfVxuXG4gICAgZ2V0IGNsaWVudFJlY3QoKTogQ2xpZW50UmVjdCB7XG4gICAgICAgIHJldHVybiB0aGlzLmxhc3RDbGlja2VkQ2xpZW50UmVjdDtcbiAgICB9XG5cbiAgICBnZXQgZml4ZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0IGRyb3Bkb3duQ29udGVudCgpOiBIVE1MRWxlbWVudCB8IG51bGwge1xuICAgICAgICByZXR1cm4gdGhpcy5kcm9wZG93bkJveFJlZj8uaW5zdGFuY2UuY29udGVudEVsZW1lbnRSZWY/Lm5hdGl2ZUVsZW1lbnQgfHwgbnVsbDtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gICAgb25Ib3N0Q2xpY2soKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY2xvc2VEcm9wZG93bkJveCgpO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2NvbnRleHRtZW51LnByZXZlbnQnLCBbJyRldmVudC5jbGllbnRYJywgJyRldmVudC5jbGllbnRZJ10pXG4gICAgb25Db250ZXh0TWVudSh4OiBudW1iZXIsIHk6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmNsb3NlRHJvcGRvd25Cb3goKTtcbiAgICAgICAgdGhpcy5vcGVuRHJvcGRvd24oeCwgeSk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6Y29udGV4dG1lbnUnLCBbJyRldmVudC50YXJnZXQnXSlcbiAgICBvbkFub3RoZXJDb250ZXh0T3Blbih0YXJnZXQ6IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGlzQW5vdGhlckNvbnRleHRPcGVuZWQgPSAhdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY29udGFpbnModGFyZ2V0KTtcblxuICAgICAgICBpZiAoaXNBbm90aGVyQ29udGV4dE9wZW5lZCkge1xuICAgICAgICAgICAgdGhpcy5jbG9zZURyb3Bkb3duQm94KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDprZXlkb3duLmFycm93RG93bicsIFsnJGV2ZW50JywgJ3RydWUnXSlcbiAgICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDprZXlkb3duLmFycm93VXAnLCBbJyRldmVudCcsICdmYWxzZSddKVxuICAgIG9uQXJyb3coZXZlbnQ6IEtleWJvYXJkRXZlbnQsIGRvd246IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgYWN0aXZlRWxlbWVudCA9IGdldE5hdGl2ZUZvY3VzZWQodGhpcy5kb2N1bWVudFJlZik7XG4gICAgICAgIGNvbnN0IGZvY3VzSW5zaWRlID0gYWN0aXZlRWxlbWVudCAmJiB0aGlzLmFjdGl2ZVpvbmUuY29udGFpbnMoYWN0aXZlRWxlbWVudCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmRyb3Bkb3duQ29udGVudCB8fCBmb2N1c0luc2lkZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBjb25zdCBuZXh0RWwgPSB0aGlzLmRyb3Bkb3duQ29udGVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgIGNvbnN0IGluaXRpYWwgPVxuICAgICAgICAgICAgZG93biB8fCAhdGhpcy5jaGVja0lzRm9jdXNhYmxlRWxlbWVudChuZXh0RWwpID8gdGhpcy5kcm9wZG93bkNvbnRlbnQgOiBuZXh0RWw7XG4gICAgICAgIGNvbnN0IGZvY3VzYWJsZSA9IGdldENsb3Nlc3RGb2N1c2FibGUoaW5pdGlhbCwgIWRvd24sIHRoaXMuZHJvcGRvd25Db250ZW50KTtcblxuICAgICAgICBpZiAoZm9jdXNhYmxlID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBzZXROYXRpdmVGb2N1c2VkKGZvY3VzYWJsZSk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6a2V5ZG93bi5lc2MnLCBbJyRldmVudCddKVxuICAgIG9uS2V5RG93bkVzYyhldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuZHJvcGRvd25Db250ZW50KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdGhpcy5jbG9zZURyb3Bkb3duQm94KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuRHJvcGRvd24oeDogbnVtYmVyLCB5OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5sYXN0Q2xpY2tlZENsaWVudFJlY3QgPSB0dWlQb2ludFRvQ2xpZW50UmVjdCh4LCB5KTtcbiAgICAgICAgdGhpcy5vcGVuRHJvcGRvd25Cb3goKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrSXNGb2N1c2FibGVFbGVtZW50KGVsZW1lbnQ6IEVsZW1lbnQgfCBudWxsKTogZWxlbWVudCBpcyBIVE1MRWxlbWVudCB7XG4gICAgICAgIHJldHVybiAhIWVsZW1lbnQgJiYgJ2ZvY3VzJyBpbiBlbGVtZW50ICYmICdibHVyJyBpbiBlbGVtZW50O1xuICAgIH1cbn1cbiJdfQ==