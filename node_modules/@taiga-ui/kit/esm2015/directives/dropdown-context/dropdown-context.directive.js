var TuiDropdownContextDirective_1;
import { __decorate, __param } from "tslib";
import { DOCUMENT } from '@angular/common';
import { ComponentFactoryResolver, Directive, ElementRef, forwardRef, HostListener, Inject, Injector, Input, } from '@angular/core';
import { EMPTY_CLIENT_RECT, getClosestFocusable, getNativeFocused, setNativeFocused, TuiActiveZoneDirective, tuiDefaultProp, TuiDestroyService, tuiPointToClientRect, TuiPortalService, } from '@taiga-ui/cdk';
import { AbstractTuiDropdown, TUI_DROPDOWN_DIRECTIVE } from '@taiga-ui/core';
import { EMPTY, Observable } from 'rxjs';
import { filter, takeUntil } from 'rxjs/operators';
// @dynamic
let TuiDropdownContextDirective = TuiDropdownContextDirective_1 = class TuiDropdownContextDirective extends AbstractTuiDropdown {
    constructor(elementRef, documentRef, destroy$, componentFactoryResolver, injector, portalService, activeZone) {
        super(componentFactoryResolver, injector, portalService, elementRef, activeZone);
        this.elementRef = elementRef;
        this.documentRef = documentRef;
        this.activeZone = activeZone;
        this.lastClickedClientRect = EMPTY_CLIENT_RECT;
        this.content = '';
        this.refresh$ = EMPTY;
        this.context = { close: () => this.closeDropdownBox() };
        activeZone.tuiActiveZoneChange
            .pipe(filter(isActive => !isActive), takeUntil(destroy$))
            .subscribe(() => this.closeDropdownBox());
    }
    get clientRect() {
        return this.lastClickedClientRect;
    }
    get fixed() {
        return true;
    }
    get dropdownContent() {
        var _a, _b;
        return ((_b = (_a = this.dropdownBoxRef) === null || _a === void 0 ? void 0 : _a.instance.contentElementRef) === null || _b === void 0 ? void 0 : _b.nativeElement) || null;
    }
    onHostClick() {
        this.closeDropdownBox();
    }
    onContextMenu(x, y) {
        this.closeDropdownBox();
        this.openDropdown(x, y);
    }
    onAnotherContextOpen(target) {
        const isAnotherContextOpened = !this.elementRef.nativeElement.contains(target);
        if (isAnotherContextOpened) {
            this.closeDropdownBox();
        }
    }
    onArrow(event, down) {
        const activeElement = getNativeFocused(this.documentRef);
        const focusInside = activeElement && this.activeZone.contains(activeElement);
        if (!this.dropdownContent || focusInside) {
            return;
        }
        event.preventDefault();
        const nextEl = this.dropdownContent.nextElementSibling;
        const initial = down || !this.checkIsFocusableElement(nextEl) ? this.dropdownContent : nextEl;
        const focusable = getClosestFocusable(initial, !down, this.dropdownContent);
        if (focusable === null) {
            return;
        }
        setNativeFocused(focusable);
    }
    onKeyDownEsc(event) {
        if (!this.dropdownContent) {
            return;
        }
        event.stopPropagation();
        this.closeDropdownBox();
    }
    openDropdown(x, y) {
        this.lastClickedClientRect = tuiPointToClientRect(x, y);
        this.openDropdownBox();
    }
    checkIsFocusableElement(element) {
        return !!element && 'focus' in element && 'blur' in element;
    }
};
TuiDropdownContextDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Document, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Observable, decorators: [{ type: Inject, args: [TuiDestroyService,] }] },
    { type: ComponentFactoryResolver, decorators: [{ type: Inject, args: [ComponentFactoryResolver,] }] },
    { type: Injector, decorators: [{ type: Inject, args: [Injector,] }] },
    { type: TuiPortalService, decorators: [{ type: Inject, args: [TuiPortalService,] }] },
    { type: TuiActiveZoneDirective }
];
__decorate([
    Input('tuiDropdownContext'),
    tuiDefaultProp()
], TuiDropdownContextDirective.prototype, "content", void 0);
__decorate([
    HostListener('click')
], TuiDropdownContextDirective.prototype, "onHostClick", null);
__decorate([
    HostListener('contextmenu.prevent', ['$event.clientX', '$event.clientY'])
], TuiDropdownContextDirective.prototype, "onContextMenu", null);
__decorate([
    HostListener('document:contextmenu', ['$event.target'])
], TuiDropdownContextDirective.prototype, "onAnotherContextOpen", null);
__decorate([
    HostListener('document:keydown.arrowDown', ['$event', 'true']),
    HostListener('document:keydown.arrowUp', ['$event', 'false'])
], TuiDropdownContextDirective.prototype, "onArrow", null);
__decorate([
    HostListener('document:keydown.esc', ['$event'])
], TuiDropdownContextDirective.prototype, "onKeyDownEsc", null);
TuiDropdownContextDirective = TuiDropdownContextDirective_1 = __decorate([
    Directive({
        selector: '[tuiDropdownContext]',
        providers: [
            TuiDestroyService,
            TuiActiveZoneDirective,
            {
                provide: TUI_DROPDOWN_DIRECTIVE,
                useExisting: forwardRef(() => TuiDropdownContextDirective_1),
            },
        ],
    }),
    __param(1, Inject(DOCUMENT)),
    __param(2, Inject(TuiDestroyService)),
    __param(3, Inject(ComponentFactoryResolver)),
    __param(4, Inject(Injector)),
    __param(5, Inject(TuiPortalService))
], TuiDropdownContextDirective);
export { TuiDropdownContextDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcGRvd24tY29udGV4dC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkva2l0L2RpcmVjdGl2ZXMvZHJvcGRvd24tY29udGV4dC8iLCJzb3VyY2VzIjpbImRyb3Bkb3duLWNvbnRleHQuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFDSCx3QkFBd0IsRUFDeEIsU0FBUyxFQUNULFVBQVUsRUFDVixVQUFVLEVBQ1YsWUFBWSxFQUNaLE1BQU0sRUFDTixRQUFRLEVBQ1IsS0FBSyxHQUNSLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFDSCxpQkFBaUIsRUFDakIsbUJBQW1CLEVBQ25CLGdCQUFnQixFQUNoQixnQkFBZ0IsRUFDaEIsc0JBQXNCLEVBQ3RCLGNBQWMsRUFDZCxpQkFBaUIsRUFDakIsb0JBQW9CLEVBQ3BCLGdCQUFnQixHQUNuQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsbUJBQW1CLEVBQUUsc0JBQXNCLEVBQWMsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4RixPQUFPLEVBQUMsS0FBSyxFQUFFLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUMsTUFBTSxFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRWpELFdBQVc7QUFZWCxJQUFhLDJCQUEyQixtQ0FBeEMsTUFBYSwyQkFDVCxTQUFRLG1CQUFtQjtJQWEzQixZQUN1QixVQUFzQixFQUNOLFdBQXFCLEVBQzdCLFFBQTZCLEVBRXhELHdCQUFrRCxFQUNoQyxRQUFrQixFQUNWLGFBQStCLEVBQ2hELFVBQWtDO1FBRTNDLEtBQUssQ0FBQyx3QkFBd0IsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztRQVQ5RCxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ04sZ0JB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O2dCQUMvQixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLDZCQUEyQixDQUFDO2FBQzdEO1NBQ0o7S0FDSixDQUFDO0lBaUJPLFdBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQ2hCLFdBQUEsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFDekIsV0FBQSxNQUFNLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtJQUVoQyxXQUFBLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNoQixXQUFBLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0dBckJwQiwyQkFBMkIsQ0E0R3ZDO1NBNUdZLDJCQUEyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RE9DVU1FTlR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQge1xuICAgIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBEaXJlY3RpdmUsXG4gICAgRWxlbWVudFJlZixcbiAgICBmb3J3YXJkUmVmLFxuICAgIEhvc3RMaXN0ZW5lcixcbiAgICBJbmplY3QsXG4gICAgSW5qZWN0b3IsXG4gICAgSW5wdXQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBFTVBUWV9DTElFTlRfUkVDVCxcbiAgICBnZXRDbG9zZXN0Rm9jdXNhYmxlLFxuICAgIGdldE5hdGl2ZUZvY3VzZWQsXG4gICAgc2V0TmF0aXZlRm9jdXNlZCxcbiAgICBUdWlBY3RpdmVab25lRGlyZWN0aXZlLFxuICAgIHR1aURlZmF1bHRQcm9wLFxuICAgIFR1aURlc3Ryb3lTZXJ2aWNlLFxuICAgIHR1aVBvaW50VG9DbGllbnRSZWN0LFxuICAgIFR1aVBvcnRhbFNlcnZpY2UsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsnO1xuaW1wb3J0IHtBYnN0cmFjdFR1aURyb3Bkb3duLCBUVUlfRFJPUERPV05fRElSRUNUSVZFLCBUdWlEcm9wZG93bn0gZnJvbSAnQHRhaWdhLXVpL2NvcmUnO1xuaW1wb3J0IHtQb2x5bW9ycGhldXNDb250ZW50fSBmcm9tICdAdGlua29mZi9uZy1wb2x5bW9ycGhldXMnO1xuaW1wb3J0IHtFTVBUWSwgT2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2ZpbHRlciwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbi8vIEBkeW5hbWljXG5ARGlyZWN0aXZlKHtcbiAgICBzZWxlY3RvcjogJ1t0dWlEcm9wZG93bkNvbnRleHRdJyxcbiAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgVHVpRGVzdHJveVNlcnZpY2UsXG4gICAgICAgIFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUsXG4gICAgICAgIHtcbiAgICAgICAgICAgIHByb3ZpZGU6IFRVSV9EUk9QRE9XTl9ESVJFQ1RJVkUsXG4gICAgICAgICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBUdWlEcm9wZG93bkNvbnRleHREaXJlY3RpdmUpLFxuICAgICAgICB9LFxuICAgIF0sXG59KVxuZXhwb3J0IGNsYXNzIFR1aURyb3Bkb3duQ29udGV4dERpcmVjdGl2ZVxuICAgIGV4dGVuZHMgQWJzdHJhY3RUdWlEcm9wZG93blxuICAgIGltcGxlbWVudHMgVHVpRHJvcGRvd25cbntcbiAgICBwcml2YXRlIGxhc3RDbGlja2VkQ2xpZW50UmVjdCA9IEVNUFRZX0NMSUVOVF9SRUNUO1xuXG4gICAgQElucHV0KCd0dWlEcm9wZG93bkNvbnRleHQnKVxuICAgIEB0dWlEZWZhdWx0UHJvcCgpXG4gICAgY29udGVudDogUG9seW1vcnBoZXVzQ29udGVudCA9ICcnO1xuXG4gICAgcmVhZG9ubHkgcmVmcmVzaCQgPSBFTVBUWTtcblxuICAgIHJlYWRvbmx5IGNvbnRleHQgPSB7Y2xvc2U6ICgpID0+IHRoaXMuY2xvc2VEcm9wZG93bkJveCgpfTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBkb2N1bWVudFJlZjogRG9jdW1lbnQsXG4gICAgICAgIEBJbmplY3QoVHVpRGVzdHJveVNlcnZpY2UpIGRlc3Ryb3kkOiBPYnNlcnZhYmxlPHVua25vd24+LFxuICAgICAgICBASW5qZWN0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcilcbiAgICAgICAgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgICAgIEBJbmplY3QoSW5qZWN0b3IpIGluamVjdG9yOiBJbmplY3RvcixcbiAgICAgICAgQEluamVjdChUdWlQb3J0YWxTZXJ2aWNlKSBwb3J0YWxTZXJ2aWNlOiBUdWlQb3J0YWxTZXJ2aWNlLFxuICAgICAgICByZWFkb25seSBhY3RpdmVab25lOiBUdWlBY3RpdmVab25lRGlyZWN0aXZlLFxuICAgICkge1xuICAgICAgICBzdXBlcihjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIGluamVjdG9yLCBwb3J0YWxTZXJ2aWNlLCBlbGVtZW50UmVmLCBhY3RpdmVab25lKTtcblxuICAgICAgICBhY3RpdmVab25lLnR1aUFjdGl2ZVpvbmVDaGFuZ2VcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGZpbHRlcihpc0FjdGl2ZSA9PiAhaXNBY3RpdmUpLFxuICAgICAgICAgICAgICAgIHRha2VVbnRpbChkZXN0cm95JCksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMuY2xvc2VEcm9wZG93bkJveCgpKTtcbiAgICB9XG5cbiAgICBnZXQgY2xpZW50UmVjdCgpOiBDbGllbnRSZWN0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdENsaWNrZWRDbGllbnRSZWN0O1xuICAgIH1cblxuICAgIGdldCBmaXhlZCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXQgZHJvcGRvd25Db250ZW50KCk6IEhUTUxFbGVtZW50IHwgbnVsbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmRyb3Bkb3duQm94UmVmPy5pbnN0YW5jZS5jb250ZW50RWxlbWVudFJlZj8ubmF0aXZlRWxlbWVudCB8fCBudWxsO1xuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2NsaWNrJylcbiAgICBvbkhvc3RDbGljaygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jbG9zZURyb3Bkb3duQm94KCk7XG4gICAgfVxuXG4gICAgQEhvc3RMaXN0ZW5lcignY29udGV4dG1lbnUucHJldmVudCcsIFsnJGV2ZW50LmNsaWVudFgnLCAnJGV2ZW50LmNsaWVudFknXSlcbiAgICBvbkNvbnRleHRNZW51KHg6IG51bWJlciwgeTogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY2xvc2VEcm9wZG93bkJveCgpO1xuICAgICAgICB0aGlzLm9wZW5Ecm9wZG93bih4LCB5KTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDpjb250ZXh0bWVudScsIFsnJGV2ZW50LnRhcmdldCddKVxuICAgIG9uQW5vdGhlckNvbnRleHRPcGVuKHRhcmdldDogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaXNBbm90aGVyQ29udGV4dE9wZW5lZCA9ICF0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jb250YWlucyh0YXJnZXQpO1xuXG4gICAgICAgIGlmIChpc0Fub3RoZXJDb250ZXh0T3BlbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmNsb3NlRHJvcGRvd25Cb3goKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmtleWRvd24uYXJyb3dEb3duJywgWyckZXZlbnQnLCAndHJ1ZSddKVxuICAgIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmtleWRvd24uYXJyb3dVcCcsIFsnJGV2ZW50JywgJ2ZhbHNlJ10pXG4gICAgb25BcnJvdyhldmVudDogS2V5Ym9hcmRFdmVudCwgZG93bjogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZ2V0TmF0aXZlRm9jdXNlZCh0aGlzLmRvY3VtZW50UmVmKTtcbiAgICAgICAgY29uc3QgZm9jdXNJbnNpZGUgPSBhY3RpdmVFbGVtZW50ICYmIHRoaXMuYWN0aXZlWm9uZS5jb250YWlucyhhY3RpdmVFbGVtZW50KTtcblxuICAgICAgICBpZiAoIXRoaXMuZHJvcGRvd25Db250ZW50IHx8IGZvY3VzSW5zaWRlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGNvbnN0IG5leHRFbCA9IHRoaXMuZHJvcGRvd25Db250ZW50Lm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgY29uc3QgaW5pdGlhbCA9XG4gICAgICAgICAgICBkb3duIHx8ICF0aGlzLmNoZWNrSXNGb2N1c2FibGVFbGVtZW50KG5leHRFbCkgPyB0aGlzLmRyb3Bkb3duQ29udGVudCA6IG5leHRFbDtcbiAgICAgICAgY29uc3QgZm9jdXNhYmxlID0gZ2V0Q2xvc2VzdEZvY3VzYWJsZShpbml0aWFsLCAhZG93biwgdGhpcy5kcm9wZG93bkNvbnRlbnQpO1xuXG4gICAgICAgIGlmIChmb2N1c2FibGUgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHNldE5hdGl2ZUZvY3VzZWQoZm9jdXNhYmxlKTtcbiAgICB9XG5cbiAgICBASG9zdExpc3RlbmVyKCdkb2N1bWVudDprZXlkb3duLmVzYycsIFsnJGV2ZW50J10pXG4gICAgb25LZXlEb3duRXNjKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5kcm9wZG93bkNvbnRlbnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLmNsb3NlRHJvcGRvd25Cb3goKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5Ecm9wZG93bih4OiBudW1iZXIsIHk6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmxhc3RDbGlja2VkQ2xpZW50UmVjdCA9IHR1aVBvaW50VG9DbGllbnRSZWN0KHgsIHkpO1xuICAgICAgICB0aGlzLm9wZW5Ecm9wZG93bkJveCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2hlY2tJc0ZvY3VzYWJsZUVsZW1lbnQoZWxlbWVudDogRWxlbWVudCB8IG51bGwpOiBlbGVtZW50IGlzIEhUTUxFbGVtZW50IHtcbiAgICAgICAgcmV0dXJuICEhZWxlbWVudCAmJiAnZm9jdXMnIGluIGVsZW1lbnQgJiYgJ2JsdXInIGluIGVsZW1lbnQ7XG4gICAgfVxufVxuIl19