import { Subject } from 'rxjs';
import { Euler, Quaternion } from 'three';
import { Object3D, Vector2 } from 'three';
import { RxjsTween } from '../tween/rxjs-tween';
export class ObjectControls {
    constructor(rendererDom, object, touchArea) {
        // ============= Private Properties =============
        this.isUserInteracting = false;
        this.restoringAnimationOngoing = false;
        this.restoringOriginPosTimeout = 0;
        this.userInteracted = false;
        this.userInteractedSubject = new Subject();
        // ============= Public Properties =============
        this.rotationSpeed = 1;
        this.verticalRotation = true;
        this.horizontalRotation = true;
        this.autoRotationY = false;
        this.autoRotationX = false;
        this.autoRotationZ = false;
        this.restoreOriginPosition = false;
        this.autoRotationSpeed = 0.002;
        this.userInteracted$ = this.userInteractedSubject.asObservable();
        this.controlsEnabled = true;
        /******************  MOUSE interaction functions - desktop  *****/
        /**
         * Prepares everything, when the mouse is clicked
         * @param e mouse event
         */
        this.mouseDown = (e) => {
            // Ignore mouse down interaction, if the controls are not enabled
            // Ignore mouse down interaction, if the restoration animation is ongoing
            if (this.controlsEnabled === false || this.restoringAnimationOngoing === true)
                return;
            // Reset restoration animation timout
            window.clearTimeout(this.restoringOriginPosTimeout);
            this.isUserInteracting = true;
            this.startDraggingPosition = new Vector2(0, 0);
            this.startDraggingPosition.set(e.offsetX, e.offsetY);
            this.touchArea.addEventListener('pointermove', this.mouseMove, false);
            this.touchArea.addEventListener('pointerup', this.mouseUp, false);
        };
        /**
         * Calculates the x and y rotation of the object depending on the mouse movement
         * @param e MouseEvent
         */
        this.mouseMove = (e) => {
            // Ignore mouse movement interaction, if the controls are not enabled
            // Ignore mouse movement interaction, if the restoration animation is ongoing
            if (this.controlsEnabled === false || this.restoringAnimationOngoing)
                return;
            if (this.isUserInteracting) {
                if (this.userInteracted == false) {
                    this.userInteracted = true;
                    this.userInteractedSubject.next(this.userInteracted);
                }
                const deltaMove = new Vector2(e.offsetX - this.startDraggingPosition.x, e.offsetY - this.startDraggingPosition.y);
                this.startDraggingPosition.set(e.offsetX, e.offsetY);
                const rotationX = this.verticalRotation == true ? (deltaMove.x * Math.PI / 180 * this.rotationSpeed) : 0;
                const rotationY = this.horizontalRotation == true ? (deltaMove.y * Math.PI / 180 * this.rotationSpeed) : 0;
                var deltaRotationQuaternion = new Quaternion().setFromEuler(new Euler(rotationY, rotationX, 0, 'XYZ'));
                this.obj.quaternion.multiplyQuaternions(deltaRotationQuaternion, this.obj.quaternion);
                //console.log(`rotX: ${Math.round(THREE.MathUtils.radToDeg(this.obj.rotation.x))}, rotY: ${Math.round(THREE.MathUtils.radToDeg(this.obj.rotation.y))}, rotZ: ${Math.round(THREE.MathUtils.radToDeg(this.obj.rotation.z))}`);
            }
        };
        this.mouseUp = () => {
            // Ignore mouse movement interaction, if the controls are not enabled
            // Ignore mouse up interaction, if the restoration animation is ongoing
            if (this.controlsEnabled === false || this.restoringAnimationOngoing)
                return;
            this.resetMousePosition();
            this.isUserInteracting = false;
            if (this.restoreOriginPosition)
                this.restoreOriginalPosition();
            this.touchArea.removeEventListener('mousemove', this.mouseMove, false);
            this.touchArea.removeEventListener('mouseup', this.mouseUp, false);
        };
        /****************** TOUCH interaction functions - mobile  *****/
        this.onTouchStart = (e) => {
            // Ignore mouse movement interaction, if the controls are not enabled
            // Ignore touch start interaction, if the restoration animation is ongoing
            if (this.controlsEnabled === false || this.restoringAnimationOngoing)
                return;
            // Reset restoration animation timout
            window.clearTimeout(this.restoringOriginPosTimeout);
            //e.preventDefault();
            this.isUserInteracting = true;
            this.restoringAnimationOngoing = false;
            this.startDraggingPosition.set(e.touches[0].pageX, e.touches[0].pageY);
        };
        this.onTouchMove = (e) => {
            // Ignore mouse movement interaction, if the controls are not enabled
            // Ignore mouse move interaction, if the restoration animation is ongoing
            if (this.controlsEnabled === false || this.restoringAnimationOngoing)
                return;
            //e.preventDefault();
            if (this.isUserInteracting && !this.restoringAnimationOngoing) {
                if (this.userInteracted == false) {
                    this.userInteracted = true;
                    this.userInteractedSubject.next(this.userInteracted);
                }
                const deltaMove = new Vector2(e.touches[0].pageX - this.startDraggingPosition.x, e.touches[0].pageY - this.startDraggingPosition.y);
                this.startDraggingPosition.set(e.touches[0].pageX, e.touches[0].pageY);
                const rotationX = this.verticalRotation == true ? (deltaMove.x * Math.PI / 180 * this.rotationSpeed) : 0;
                const rotationY = this.horizontalRotation == true ? (deltaMove.y * Math.PI / 180 * this.rotationSpeed) : 0;
                var deltaRotationQuaternion = new Quaternion().setFromEuler(new Euler(rotationY, rotationX, 0, 'XYZ'));
                this.obj.quaternion.multiplyQuaternions(deltaRotationQuaternion, this.obj.quaternion);
            }
        };
        this.onTouchEnd = (e) => {
            // Ignore mouse movement interaction, if the controls are not enabled
            // Ignore mouse up interaction, if the restoration animation is ongoing
            if (this.controlsEnabled === false || this.restoringAnimationOngoing)
                return;
            //e.preventDefault();
            this.isUserInteracting = false;
            this.resetMousePosition();
            if (this.restoreOriginPosition)
                this.restoreOriginalPosition();
        };
        this.rendererDom = rendererDom;
        this.obj = object;
        this.touchArea = touchArea != null ? touchArea : this.rendererDom;
        this.startDraggingPosition = new Vector2(0, 0);
        this.addEventlisteners();
    }
    // ============= Public Methods =============
    /**
     * Method, which needs to be called, in case autorotation is used
     */
    update() {
        if (this.isUserInteracting || this.restoringAnimationOngoing || this.userInteracted)
            return;
        var rotationY = this.autoRotationY == true ? this.autoRotationSpeed : 0;
        var rotationX = this.autoRotationX == true ? this.autoRotationSpeed : 0;
        var rorationZ = this.autoRotationZ == true ? this.autoRotationSpeed : 0;
        var deltaRotationQuaternion = new Quaternion().setFromEuler(new Euler(rotationX, rotationY, rorationZ, 'XYZ'));
        this.obj.quaternion.multiplyQuaternions(deltaRotationQuaternion, this.obj.quaternion);
    }
    /**
     * Removes the event listners
     */
    removeEventlisteners() {
        // desktop events
        this.touchArea.removeEventListener('mousedown', this.mouseDown, false);
        this.touchArea.removeEventListener('mousemove', this.mouseMove, false);
        this.touchArea.removeEventListener('mouseup', this.mouseUp, false);
        // mobile events
        this.touchArea.removeEventListener('touchstart', this.onTouchStart, false);
        this.touchArea.removeEventListener('touchmove', this.onTouchMove, false);
        this.touchArea.removeEventListener('touchend', this.onTouchEnd, false);
    }
    resetUserInteractionFlag() {
        this.userInteracted = false,
            this.userInteractedSubject.next(this.userInteracted);
    }
    // ============= Private Methods =============
    /**
     * Adds the event listeners
     */
    addEventlisteners() {
        // desktop events
        this.touchArea.addEventListener('mousedown', this.mouseDown, false);
        // mobile events
        this.touchArea.addEventListener('touchend', this.onTouchEnd, false);
        this.touchArea.addEventListener('touchstart', this.onTouchStart, false);
        this.touchArea.addEventListener('touchmove', this.onTouchMove, false);
    }
    /**
     * Reset the mouse position to x=0 and y=0
     */
    resetMousePosition() {
        this.startDraggingPosition.set(0, 0);
    }
    /**
     * Rotates the object to the position 0,0,0 after a some timeout
     */
    restoreOriginalPosition() {
        this.restoringOriginPosTimeout = window.setTimeout(() => {
            var objSet = new Object3D();
            objSet.position.set(0, 0, 0);
            objSet.rotation.set(0, 0, 0);
            RxjsTween.createTween(RxjsTween.linear, [this.obj.position.x, this.obj.position.y, this.obj.position.z], [objSet.position.x, objSet.position.y, objSet.position.z], 1000).subscribe({
                next: tweenVal => {
                    if (this.restoringAnimationOngoing == false)
                        this.restoringAnimationOngoing = true;
                    this.obj.rotation.set(tweenVal[0], tweenVal[1], tweenVal[2]);
                },
                complete: () => {
                    this.restoringAnimationOngoing = false;
                    this.resetUserInteractionFlag();
                }
            });
        }, 5000);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqZWN0LWNvbnRyb2xzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWFjdXcvc3JjL2xpYi9jb250cm9scy9vYmplY3QtY29udHJvbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUMxQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLE9BQU8sQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFaEQsTUFBTSxPQUFPLGNBQWM7SUF5QnZCLFlBQVksV0FBd0IsRUFBRSxNQUFnQyxFQUFFLFNBQXVCO1FBdkIvRixpREFBaUQ7UUFDekMsc0JBQWlCLEdBQVksS0FBSyxDQUFDO1FBQ25DLDhCQUF5QixHQUFZLEtBQUssQ0FBQztRQUMzQyw4QkFBeUIsR0FBRyxDQUFDLENBQUM7UUFLOUIsbUJBQWMsR0FBWSxLQUFLLENBQUM7UUFDaEMsMEJBQXFCLEdBQXFCLElBQUksT0FBTyxFQUFFLENBQUM7UUFFaEUsZ0RBQWdEO1FBQ2hELGtCQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLHFCQUFnQixHQUFHLElBQUksQ0FBQztRQUN4Qix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUFDdEIsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUFDdEIsa0JBQWEsR0FBRyxLQUFLLENBQUM7UUFDdEIsMEJBQXFCLEdBQUcsS0FBSyxDQUFDO1FBQzlCLHNCQUFpQixHQUFHLEtBQUssQ0FBQztRQUMxQixvQkFBZSxHQUF3QixJQUFJLENBQUMscUJBQXFCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDakYsb0JBQWUsR0FBRyxJQUFJLENBQUM7UUF5RXZCLGtFQUFr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LEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDYixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBFdWxlciwgUXVhdGVybmlvbiB9IGZyb20gJ3RocmVlJztcbmltcG9ydCB7IE9iamVjdDNELCBWZWN0b3IyIH0gZnJvbSAndGhyZWUnO1xuaW1wb3J0IHsgUnhqc1R3ZWVuIH0gZnJvbSAnLi4vdHdlZW4vcnhqcy10d2Vlbic7XG5cbmV4cG9ydCBjbGFzcyBPYmplY3RDb250cm9scyB7XG5cbiAgICAvLyA9PT09PT09PT09PT09IFByaXZhdGUgUHJvcGVydGllcyA9PT09PT09PT09PT09XG4gICAgcHJpdmF0ZSBpc1VzZXJJbnRlcmFjdGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgcmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZzogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgcmVzdG9yaW5nT3JpZ2luUG9zVGltZW91dCA9IDA7XG4gICAgcHJpdmF0ZSBzdGFydERyYWdnaW5nUG9zaXRpb246IFZlY3RvcjI7XG4gICAgcHJpdmF0ZSByZW5kZXJlckRvbTogSFRNTEVsZW1lbnQ7XG4gICAgcHJpdmF0ZSB0b3VjaEFyZWE6IEhUTUxFbGVtZW50O1xuICAgIHByaXZhdGUgb2JqOiBUSFJFRS5NZXNoIHwgVEhSRUUuR3JvdXA7XG4gICAgcHJpdmF0ZSB1c2VySW50ZXJhY3RlZDogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgdXNlckludGVyYWN0ZWRTdWJqZWN0OiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3QoKTtcblxuICAgIC8vID09PT09PT09PT09PT0gUHVibGljIFByb3BlcnRpZXMgPT09PT09PT09PT09PVxuICAgIHJvdGF0aW9uU3BlZWQgPSAxO1xuICAgIHZlcnRpY2FsUm90YXRpb24gPSB0cnVlO1xuICAgIGhvcml6b250YWxSb3RhdGlvbiA9IHRydWU7XG4gICAgYXV0b1JvdGF0aW9uWSA9IGZhbHNlO1xuICAgIGF1dG9Sb3RhdGlvblggPSBmYWxzZTtcbiAgICBhdXRvUm90YXRpb25aID0gZmFsc2U7XG4gICAgcmVzdG9yZU9yaWdpblBvc2l0aW9uID0gZmFsc2U7XG4gICAgYXV0b1JvdGF0aW9uU3BlZWQgPSAwLjAwMjtcbiAgICB1c2VySW50ZXJhY3RlZCQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzLnVzZXJJbnRlcmFjdGVkU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICBjb250cm9sc0VuYWJsZWQgPSB0cnVlO1xuXG4gICAgY29uc3RydWN0b3IocmVuZGVyZXJEb206IEhUTUxFbGVtZW50LCBvYmplY3Q6IFRIUkVFLk1lc2ggfCBUSFJFRS5Hcm91cCwgdG91Y2hBcmVhPzogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlckRvbSA9IHJlbmRlcmVyRG9tO1xuICAgICAgICB0aGlzLm9iaiA9IG9iamVjdDtcbiAgICAgICAgdGhpcy50b3VjaEFyZWEgPSB0b3VjaEFyZWEgIT0gbnVsbCA/IHRvdWNoQXJlYSA6IHRoaXMucmVuZGVyZXJEb207XG5cbiAgICAgICAgdGhpcy5zdGFydERyYWdnaW5nUG9zaXRpb24gPSBuZXcgVmVjdG9yMigwLCAwKTtcblxuICAgICAgICB0aGlzLmFkZEV2ZW50bGlzdGVuZXJzKCk7XG4gICAgfVxuXG4gICAgLy8gPT09PT09PT09PT09PSBQdWJsaWMgTWV0aG9kcyA9PT09PT09PT09PT09XG5cbiAgICAvKipcbiAgICAgKiBNZXRob2QsIHdoaWNoIG5lZWRzIHRvIGJlIGNhbGxlZCwgaW4gY2FzZSBhdXRvcm90YXRpb24gaXMgdXNlZFxuICAgICAqL1xuICAgIHVwZGF0ZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaXNVc2VySW50ZXJhY3RpbmcgfHwgdGhpcy5yZXN0b3JpbmdBbmltYXRpb25PbmdvaW5nIHx8IHRoaXMudXNlckludGVyYWN0ZWQpIHJldHVybjtcblxuICAgICAgICB2YXIgcm90YXRpb25ZID0gdGhpcy5hdXRvUm90YXRpb25ZID09IHRydWUgPyB0aGlzLmF1dG9Sb3RhdGlvblNwZWVkIDogMDtcbiAgICAgICAgdmFyIHJvdGF0aW9uWCA9IHRoaXMuYXV0b1JvdGF0aW9uWCA9PSB0cnVlID8gdGhpcy5hdXRvUm90YXRpb25TcGVlZCA6IDA7XG4gICAgICAgIHZhciByb3JhdGlvblogPSB0aGlzLmF1dG9Sb3RhdGlvblogPT0gdHJ1ZSA/IHRoaXMuYXV0b1JvdGF0aW9uU3BlZWQgOiAwO1xuXG4gICAgICAgIHZhciBkZWx0YVJvdGF0aW9uUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCkuc2V0RnJvbUV1bGVyKG5ldyBFdWxlcihcbiAgICAgICAgICAgIHJvdGF0aW9uWCxcbiAgICAgICAgICAgIHJvdGF0aW9uWSxcbiAgICAgICAgICAgIHJvcmF0aW9uWixcbiAgICAgICAgICAgICdYWVonXG4gICAgICAgICkpO1xuICAgICAgICB0aGlzLm9iai5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoZGVsdGFSb3RhdGlvblF1YXRlcm5pb24sIHRoaXMub2JqLnF1YXRlcm5pb24pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZXMgdGhlIGV2ZW50IGxpc3RuZXJzXG4gICAgICovXG4gICAgcmVtb3ZlRXZlbnRsaXN0ZW5lcnMoKTogdm9pZCB7XG4gICAgICAgIC8vIGRlc2t0b3AgZXZlbnRzXG4gICAgICAgIHRoaXMudG91Y2hBcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMubW91c2VEb3duLCBmYWxzZSk7XG4gICAgICAgIHRoaXMudG91Y2hBcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMubW91c2VNb3ZlLCBmYWxzZSk7XG4gICAgICAgIHRoaXMudG91Y2hBcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLm1vdXNlVXAsIGZhbHNlKTtcbiAgICAgICAgLy8gbW9iaWxlIGV2ZW50c1xuICAgICAgICB0aGlzLnRvdWNoQXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgdGhpcy5vblRvdWNoU3RhcnQsIGZhbHNlKTtcbiAgICAgICAgdGhpcy50b3VjaEFyZWEucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5vblRvdWNoTW92ZSwgZmFsc2UpO1xuICAgICAgICB0aGlzLnRvdWNoQXJlYS5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMub25Ub3VjaEVuZCwgZmFsc2UpO1xuICAgIH1cblxuICAgIHJlc2V0VXNlckludGVyYWN0aW9uRmxhZygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy51c2VySW50ZXJhY3RlZCA9IGZhbHNlLFxuICAgICAgICAgICAgdGhpcy51c2VySW50ZXJhY3RlZFN1YmplY3QubmV4dCh0aGlzLnVzZXJJbnRlcmFjdGVkKTtcbiAgICB9XG5cbiAgICAvLyA9PT09PT09PT09PT09IFByaXZhdGUgTWV0aG9kcyA9PT09PT09PT09PT09XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIHRoZSBldmVudCBsaXN0ZW5lcnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGFkZEV2ZW50bGlzdGVuZXJzKCk6IHZvaWQge1xuICAgICAgICAvLyBkZXNrdG9wIGV2ZW50c1xuICAgICAgICB0aGlzLnRvdWNoQXJlYS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLm1vdXNlRG93biwgZmFsc2UpO1xuICAgICAgICAvLyBtb2JpbGUgZXZlbnRzXG4gICAgICAgIHRoaXMudG91Y2hBcmVhLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5vblRvdWNoRW5kLCBmYWxzZSk7XG4gICAgICAgIHRoaXMudG91Y2hBcmVhLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLm9uVG91Y2hTdGFydCwgZmFsc2UpO1xuICAgICAgICB0aGlzLnRvdWNoQXJlYS5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLm9uVG91Y2hNb3ZlLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmVzZXQgdGhlIG1vdXNlIHBvc2l0aW9uIHRvIHg9MCBhbmQgeT0wXG4gICAgICovXG4gICAgcHJpdmF0ZSByZXNldE1vdXNlUG9zaXRpb24oKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3RhcnREcmFnZ2luZ1Bvc2l0aW9uLnNldCgwLCAwKTtcbiAgICB9XG5cbiAgICAvKioqKioqKioqKioqKioqKioqICBNT1VTRSBpbnRlcmFjdGlvbiBmdW5jdGlvbnMgLSBkZXNrdG9wICAqKioqKi9cbiAgICAvKipcbiAgICAgKiBQcmVwYXJlcyBldmVyeXRoaW5nLCB3aGVuIHRoZSBtb3VzZSBpcyBjbGlja2VkXG4gICAgICogQHBhcmFtIGUgbW91c2UgZXZlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIG1vdXNlRG93biA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgIC8vIElnbm9yZSBtb3VzZSBkb3duIGludGVyYWN0aW9uLCBpZiB0aGUgY29udHJvbHMgYXJlIG5vdCBlbmFibGVkXG4gICAgICAgIC8vIElnbm9yZSBtb3VzZSBkb3duIGludGVyYWN0aW9uLCBpZiB0aGUgcmVzdG9yYXRpb24gYW5pbWF0aW9uIGlzIG9uZ29pbmdcbiAgICAgICAgaWYgKHRoaXMuY29udHJvbHNFbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLnJlc3RvcmluZ0FuaW1hdGlvbk9uZ29pbmcgPT09IHRydWUpIHJldHVybjtcbiAgICAgICAgLy8gUmVzZXQgcmVzdG9yYXRpb24gYW5pbWF0aW9uIHRpbW91dFxuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMucmVzdG9yaW5nT3JpZ2luUG9zVGltZW91dCk7XG5cbiAgICAgICAgdGhpcy5pc1VzZXJJbnRlcmFjdGluZyA9IHRydWU7XG4gICAgICAgIHRoaXMuc3RhcnREcmFnZ2luZ1Bvc2l0aW9uID0gbmV3IFZlY3RvcjIoMCwgMCk7XG4gICAgICAgIHRoaXMuc3RhcnREcmFnZ2luZ1Bvc2l0aW9uLnNldChlLm9mZnNldFgsIGUub2Zmc2V0WSk7XG5cbiAgICAgICAgdGhpcy50b3VjaEFyZWEuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcm1vdmUnLCB0aGlzLm1vdXNlTW92ZSwgZmFsc2UpO1xuICAgICAgICB0aGlzLnRvdWNoQXJlYS5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVydXAnLCB0aGlzLm1vdXNlVXAsIGZhbHNlKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGVzIHRoZSB4IGFuZCB5IHJvdGF0aW9uIG9mIHRoZSBvYmplY3QgZGVwZW5kaW5nIG9uIHRoZSBtb3VzZSBtb3ZlbWVudFxuICAgICAqIEBwYXJhbSBlIE1vdXNlRXZlbnRcbiAgICAgKi9cbiAgICBwcml2YXRlIG1vdXNlTW92ZSA9IChlOiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgIC8vIElnbm9yZSBtb3VzZSBtb3ZlbWVudCBpbnRlcmFjdGlvbiwgaWYgdGhlIGNvbnRyb2xzIGFyZSBub3QgZW5hYmxlZFxuICAgICAgICAvLyBJZ25vcmUgbW91c2UgbW92ZW1lbnQgaW50ZXJhY3Rpb24sIGlmIHRoZSByZXN0b3JhdGlvbiBhbmltYXRpb24gaXMgb25nb2luZ1xuICAgICAgICBpZiAodGhpcy5jb250cm9sc0VuYWJsZWQgPT09IGZhbHNlIHx8IHRoaXMucmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZykgcmV0dXJuO1xuICAgICAgICBpZiAodGhpcy5pc1VzZXJJbnRlcmFjdGluZykge1xuICAgICAgICAgICAgaWYgKHRoaXMudXNlckludGVyYWN0ZWQgPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJJbnRlcmFjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJJbnRlcmFjdGVkU3ViamVjdC5uZXh0KHRoaXMudXNlckludGVyYWN0ZWQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBkZWx0YU1vdmUgPSBuZXcgVmVjdG9yMihcbiAgICAgICAgICAgICAgICBlLm9mZnNldFggLSB0aGlzLnN0YXJ0RHJhZ2dpbmdQb3NpdGlvbi54LFxuICAgICAgICAgICAgICAgIGUub2Zmc2V0WSAtIHRoaXMuc3RhcnREcmFnZ2luZ1Bvc2l0aW9uLnlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0RHJhZ2dpbmdQb3NpdGlvbi5zZXQoZS5vZmZzZXRYLCBlLm9mZnNldFkpO1xuXG4gICAgICAgICAgICBjb25zdCByb3RhdGlvblggPSB0aGlzLnZlcnRpY2FsUm90YXRpb24gPT0gdHJ1ZSA/IChkZWx0YU1vdmUueCAqIE1hdGguUEkgLyAxODAgKiB0aGlzLnJvdGF0aW9uU3BlZWQpIDogMDtcbiAgICAgICAgICAgIGNvbnN0IHJvdGF0aW9uWSA9IHRoaXMuaG9yaXpvbnRhbFJvdGF0aW9uID09IHRydWUgPyAoZGVsdGFNb3ZlLnkgKiBNYXRoLlBJIC8gMTgwICogdGhpcy5yb3RhdGlvblNwZWVkKSA6IDA7XG5cbiAgICAgICAgICAgIHZhciBkZWx0YVJvdGF0aW9uUXVhdGVybmlvbiA9IG5ldyBRdWF0ZXJuaW9uKCkuc2V0RnJvbUV1bGVyKG5ldyBFdWxlcihcbiAgICAgICAgICAgICAgICByb3RhdGlvblksXG4gICAgICAgICAgICAgICAgcm90YXRpb25YLFxuICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgJ1hZWidcbiAgICAgICAgICAgICkpO1xuXG4gICAgICAgICAgICB0aGlzLm9iai5xdWF0ZXJuaW9uLm11bHRpcGx5UXVhdGVybmlvbnMoZGVsdGFSb3RhdGlvblF1YXRlcm5pb24sIHRoaXMub2JqLnF1YXRlcm5pb24pO1xuXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKGByb3RYOiAke01hdGgucm91bmQoVEhSRUUuTWF0aFV0aWxzLnJhZFRvRGVnKHRoaXMub2JqLnJvdGF0aW9uLngpKX0sIHJvdFk6ICR7TWF0aC5yb3VuZChUSFJFRS5NYXRoVXRpbHMucmFkVG9EZWcodGhpcy5vYmoucm90YXRpb24ueSkpfSwgcm90WjogJHtNYXRoLnJvdW5kKFRIUkVFLk1hdGhVdGlscy5yYWRUb0RlZyh0aGlzLm9iai5yb3RhdGlvbi56KSl9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG1vdXNlVXAgPSAoKSA9PiB7XG4gICAgICAgIC8vIElnbm9yZSBtb3VzZSBtb3ZlbWVudCBpbnRlcmFjdGlvbiwgaWYgdGhlIGNvbnRyb2xzIGFyZSBub3QgZW5hYmxlZFxuICAgICAgICAvLyBJZ25vcmUgbW91c2UgdXAgaW50ZXJhY3Rpb24sIGlmIHRoZSByZXN0b3JhdGlvbiBhbmltYXRpb24gaXMgb25nb2luZ1xuICAgICAgICBpZiAodGhpcy5jb250cm9sc0VuYWJsZWQgPT09IGZhbHNlIHx8IHRoaXMucmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZykgcmV0dXJuO1xuICAgICAgICB0aGlzLnJlc2V0TW91c2VQb3NpdGlvbigpO1xuICAgICAgICB0aGlzLmlzVXNlckludGVyYWN0aW5nID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnJlc3RvcmVPcmlnaW5Qb3NpdGlvbikgdGhpcy5yZXN0b3JlT3JpZ2luYWxQb3NpdGlvbigpO1xuXG4gICAgICAgIHRoaXMudG91Y2hBcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMubW91c2VNb3ZlLCBmYWxzZSk7XG4gICAgICAgIHRoaXMudG91Y2hBcmVhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLm1vdXNlVXAsIGZhbHNlKTtcbiAgICB9XG5cbiAgICAvKioqKioqKioqKioqKioqKioqIFRPVUNIIGludGVyYWN0aW9uIGZ1bmN0aW9ucyAtIG1vYmlsZSAgKioqKiovXG4gICAgcHJpdmF0ZSBvblRvdWNoU3RhcnQgPSAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgICAgICAvLyBJZ25vcmUgbW91c2UgbW92ZW1lbnQgaW50ZXJhY3Rpb24sIGlmIHRoZSBjb250cm9scyBhcmUgbm90IGVuYWJsZWRcbiAgICAgICAgLy8gSWdub3JlIHRvdWNoIHN0YXJ0IGludGVyYWN0aW9uLCBpZiB0aGUgcmVzdG9yYXRpb24gYW5pbWF0aW9uIGlzIG9uZ29pbmdcbiAgICAgICAgaWYgKHRoaXMuY29udHJvbHNFbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLnJlc3RvcmluZ0FuaW1hdGlvbk9uZ29pbmcpIHJldHVybjtcbiAgICAgICAgLy8gUmVzZXQgcmVzdG9yYXRpb24gYW5pbWF0aW9uIHRpbW91dFxuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMucmVzdG9yaW5nT3JpZ2luUG9zVGltZW91dCk7XG5cbiAgICAgICAgLy9lLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoaXMuaXNVc2VySW50ZXJhY3RpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLnJlc3RvcmluZ0FuaW1hdGlvbk9uZ29pbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5zdGFydERyYWdnaW5nUG9zaXRpb24uc2V0KFxuICAgICAgICAgICAgZS50b3VjaGVzWzBdLnBhZ2VYLCBlLnRvdWNoZXNbMF0ucGFnZVlcbiAgICAgICAgKVxuICAgIH1cblxuICAgIHByaXZhdGUgb25Ub3VjaE1vdmUgPSAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgICAgICAvLyBJZ25vcmUgbW91c2UgbW92ZW1lbnQgaW50ZXJhY3Rpb24sIGlmIHRoZSBjb250cm9scyBhcmUgbm90IGVuYWJsZWRcbiAgICAgICAgLy8gSWdub3JlIG1vdXNlIG1vdmUgaW50ZXJhY3Rpb24sIGlmIHRoZSByZXN0b3JhdGlvbiBhbmltYXRpb24gaXMgb25nb2luZ1xuICAgICAgICBpZiAodGhpcy5jb250cm9sc0VuYWJsZWQgPT09IGZhbHNlIHx8IHRoaXMucmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZykgcmV0dXJuO1xuICAgICAgICAvL2UucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgaWYgKHRoaXMuaXNVc2VySW50ZXJhY3RpbmcgJiYgIXRoaXMucmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZykge1xuICAgICAgICAgICAgaWYgKHRoaXMudXNlckludGVyYWN0ZWQgPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJJbnRlcmFjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJJbnRlcmFjdGVkU3ViamVjdC5uZXh0KHRoaXMudXNlckludGVyYWN0ZWQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBkZWx0YU1vdmUgPSBuZXcgVmVjdG9yMihcbiAgICAgICAgICAgICAgICBlLnRvdWNoZXNbMF0ucGFnZVggLSB0aGlzLnN0YXJ0RHJhZ2dpbmdQb3NpdGlvbi54LFxuICAgICAgICAgICAgICAgIGUudG91Y2hlc1swXS5wYWdlWSAtIHRoaXMuc3RhcnREcmFnZ2luZ1Bvc2l0aW9uLnlcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhcnREcmFnZ2luZ1Bvc2l0aW9uLnNldChlLnRvdWNoZXNbMF0ucGFnZVgsIGUudG91Y2hlc1swXS5wYWdlWSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHJvdGF0aW9uWCA9IHRoaXMudmVydGljYWxSb3RhdGlvbiA9PSB0cnVlID8gKGRlbHRhTW92ZS54ICogTWF0aC5QSSAvIDE4MCAqIHRoaXMucm90YXRpb25TcGVlZCkgOiAwO1xuICAgICAgICAgICAgY29uc3Qgcm90YXRpb25ZID0gdGhpcy5ob3Jpem9udGFsUm90YXRpb24gPT0gdHJ1ZSA/IChkZWx0YU1vdmUueSAqIE1hdGguUEkgLyAxODAgKiB0aGlzLnJvdGF0aW9uU3BlZWQpIDogMDtcblxuICAgICAgICAgICAgdmFyIGRlbHRhUm90YXRpb25RdWF0ZXJuaW9uID0gbmV3IFF1YXRlcm5pb24oKS5zZXRGcm9tRXVsZXIobmV3IEV1bGVyKFxuICAgICAgICAgICAgICAgIHJvdGF0aW9uWSxcbiAgICAgICAgICAgICAgICByb3RhdGlvblgsXG4gICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAnWFlaJ1xuICAgICAgICAgICAgKSk7XG5cbiAgICAgICAgICAgIHRoaXMub2JqLnF1YXRlcm5pb24ubXVsdGlwbHlRdWF0ZXJuaW9ucyhkZWx0YVJvdGF0aW9uUXVhdGVybmlvbiwgdGhpcy5vYmoucXVhdGVybmlvbik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uVG91Y2hFbmQgPSAoZTogVG91Y2hFdmVudCkgPT4ge1xuICAgICAgICAvLyBJZ25vcmUgbW91c2UgbW92ZW1lbnQgaW50ZXJhY3Rpb24sIGlmIHRoZSBjb250cm9scyBhcmUgbm90IGVuYWJsZWRcbiAgICAgICAgLy8gSWdub3JlIG1vdXNlIHVwIGludGVyYWN0aW9uLCBpZiB0aGUgcmVzdG9yYXRpb24gYW5pbWF0aW9uIGlzIG9uZ29pbmdcbiAgICAgICAgaWYgKHRoaXMuY29udHJvbHNFbmFibGVkID09PSBmYWxzZSB8fCB0aGlzLnJlc3RvcmluZ0FuaW1hdGlvbk9uZ29pbmcpIHJldHVybjtcbiAgICAgICAgLy9lLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoaXMuaXNVc2VySW50ZXJhY3RpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZXNldE1vdXNlUG9zaXRpb24oKTtcbiAgICAgICAgaWYgKHRoaXMucmVzdG9yZU9yaWdpblBvc2l0aW9uKSB0aGlzLnJlc3RvcmVPcmlnaW5hbFBvc2l0aW9uKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUm90YXRlcyB0aGUgb2JqZWN0IHRvIHRoZSBwb3NpdGlvbiAwLDAsMCBhZnRlciBhIHNvbWUgdGltZW91dFxuICAgICAqL1xuICAgIHByaXZhdGUgcmVzdG9yZU9yaWdpbmFsUG9zaXRpb24oKTogdm9pZCB7XG4gICAgICAgIHRoaXMucmVzdG9yaW5nT3JpZ2luUG9zVGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIHZhciBvYmpTZXQgPSBuZXcgT2JqZWN0M0QoKTtcbiAgICAgICAgICAgIG9ialNldC5wb3NpdGlvbi5zZXQoMCwgMCwgMCk7XG4gICAgICAgICAgICBvYmpTZXQucm90YXRpb24uc2V0KDAsIDAsIDApO1xuXG4gICAgICAgICAgICBSeGpzVHdlZW4uY3JlYXRlVHdlZW4oUnhqc1R3ZWVuLmxpbmVhciwgW3RoaXMub2JqLnBvc2l0aW9uLngsIHRoaXMub2JqLnBvc2l0aW9uLnksIHRoaXMub2JqLnBvc2l0aW9uLnpdLFxuICAgICAgICAgICAgICAgIFtvYmpTZXQucG9zaXRpb24ueCwgb2JqU2V0LnBvc2l0aW9uLnksIG9ialNldC5wb3NpdGlvbi56XSwgMTAwMCkuc3Vic2NyaWJlKHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dDogdHdlZW5WYWwgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZyA9PSBmYWxzZSkgdGhpcy5yZXN0b3JpbmdBbmltYXRpb25PbmdvaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub2JqLnJvdGF0aW9uLnNldCh0d2VlblZhbFswXSwgdHdlZW5WYWxbMV0sIHR3ZWVuVmFsWzJdKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGU6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVzdG9yaW5nQW5pbWF0aW9uT25nb2luZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFVzZXJJbnRlcmFjdGlvbkZsYWcoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCA1MDAwKTtcbiAgICB9XG59XG4iXX0=